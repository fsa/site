# О переходе на IPv6

Бурный рост сети интернет в 1990-е годы привёл к значительному расходованию доступных IP адресов. Стало очевидно, что продолжающийся рост количества устройств приведёт к тому, что свободных IP адресов просто не останется. В 2010-х годах региональные интернет-регистраторы распределяли последние доступные им блоки. В настоящее время при необходимости получить блок адресов IPv4 вы будете поставлены в очередь и сможете получить адреса в порядке очереди только если кто-то другой освободит необходимый пул адресов.

Конечно, тенденция к исчерпанию адресного пространства поставила перед инженерами задачу изменения протокола IP для расширения адресного пространства. После анализа существующего протокола стало очевидно, что разместить дополнительные биты адреса внутри существующего пакета невозможно, а любые изменения потребуют обновления программного обеспечения на всех устройствах, которые работают с протоколом IP. Ввиду этого было решено полностью переработать протокол и, кроме расширения адресного пространства, устранить недостатки старого протокола, которые были выявлены в процессе его эксплуатации. Так появился протокол IPv6.

Что мы имеем на текущее время? В сети есть два протокола IP. При этом старая версия, которую часто обозначают как IPv4 имеет значительное распространение и даже доминирующее положение во многих сетях. Новая версия протокола, обозначаемая как IPv6, активно поддерживается крупнейшими представителями IT-гигантов. Уровень внедрения новой версии протокола может значительно отличаться от страны к стране.

Новая версия протокола IP может проставить всё тоже самое, что предоставляла старая версия IP. При этом у новой версии нет недостатка в количестве адресов, а также имеется значительный запас адресного пространства.

Так в чём же проблема? На самом деле если бы произошло чудо и всё сетевое оборудование вдруг лишилось IPv4 и обзавелось поддержкой IPv6, то пользователи вряд ли заметили перемен. Программного обеспечения, которое жёстко завязано на IPv4 адреса минимальное количество. Увы, чудес не бывает, поэтому некоторое время придётся жить в мире где есть две версии протокола.

## Избавляемся от IPv4

Итак. Мы хотим избавиться от двойной работы по настройке сети и оставить только новый протокол IPv6. Сделаем это и попробуем выйти в интернет. Youtube, Яндекс, Facebook и др. Вроде бы ничего не изменилось. Всё работает как и раньше.

Запускаем торрент клиент и идём на любимы трекер. Пробуем загрузить что-нибудь. И тут видим первую проблему. Большая часть раздач не грузится. Некоторые раздачи идут, но медленно, некоторые работают без проблем. А виной всему то, что мы потеряли доступ к основной части пиров, которые работают только с IPv4 протоколом.

Ну что ж. Как на счёт того, что может понадобиться в РФ, зайдём на сайты: Госуслуги, Сбербанк, ВТБ, Ростелеком... Увы, но сайты недоступны. Это совсем не то, что нам надо.

## NAT64 или получаем доступ к узлам с IPv4

Начнём решать наши проблемы. Первое, что нам необходимо сделать - каким-то образом обеспечить связь с узлами, которые используют только IPv4 адреса.

Если вы интересовались тем, как работает IPv6 протокол, то знаете, что для адресации внутри сегмента сети IPv6 используется 64 бита. Этого более чем достаточно, чтобы уместить всю IPv4 адресацию внутри одной подсети IPv6.

Что необходимо, чтобы отправить пакет узлу с IPv4 адресом? Нам тоже нужен IPv4 адрес. Поскольку от адресации IPv4 внутри сети мы избавились, то нам нужен будет какой-то промежуточный узел, который сможет взаимодействовать по IPv6 с нашей сеть и по IPv4 с интернетом. Ничего не напоминает? Да это же всем известный NAT, который используется в IPv4 повсеместно, в том числе на вашем домашнем маршрутизаторе. Но есть небольшая разница. Если в нашем случае нам нужно преобразовывать IPv6 в IPv4 и обратно, то ранее было преобразование IPv4 в другой IPv4 и обратно. Таким образом, чтобы не путать эти типы NAT, обозначим старый как NAT44, а наш новый тип NAT64.

Всё новое - это хорошо забытое старое. Теперь в нашей сети появился специальный шлюз, который выполняет преобразование NAT64. Теперь любой узел нашей сети может отправить запрос на шлюз и через него получить ответ от узла IPv4. Например, пусть наш шлюз имеет адресацию 2001:db8::/64. В этом случае он может использовать адресацию 2001:db8::/96 для отображения всех адресов сети интернет. Если нам необходимо обратиться к узлу `1.1.1.1`, то мы просто посылаем запрос не на `1.1.1.1`, а на адрес `2001:db8::101:101`. Чтобы было удобнее для людей, существует ещё специальная запись для такого применения адресов: `2001:db8::1.1.1.1`. В этом случае IPv4 адрес записывается как есть.

Поскольку некоторое время NAT64 будет актуален, то для него был выделен специальный диапазон адресов: `64:ff9b::/96`. Именно его рекомендуют использовать внутри вашей локальной сети для вашего шлюза NAT64. Таким образом адрес `1.1.1.1` превращается в `64:ff9b::1.1.1.1`, что также можно записать как `64:ff9b::101:101`.

Отлично. Доступ к узлам IPv4 мы получили.

```console
$ ping 64:ff9b::1.1.1.1
PING 64:ff9b::1.1.1.1 (64:ff9b::101:101) 56 data bytes
64 bytes from 64:ff9b::101:101: icmp_seq=1 ttl=59 time=48.4 ms
64 bytes from 64:ff9b::101:101: icmp_seq=2 ttl=59 time=53.8 ms
```

Но что-то тут всё равно не так. Тем где мы указываем IPv4 адреса, мы можем сменить `1.1.1.1` на `64:ff9b::1.1.1.1`. Но такие случаи практически не встречаются. Поэтому выполним следующий шаг и перейдём к настройке специального DNS сервера.

## DNS64

Что происходит, когда какое-то приложение обращается по определённому доменному имени? Прежде чем обратиться к IP адресу сервера система должна этот адрес найти. Если вы обращаетесь к доменному имени, то получаете ответ от системы DNS. Рассмотрим типичный ответ на примере домена `music.yandex.ru`:

```console
$ host music.yandex.ru
music.yandex.ru has address 213.180.204.186
music.yandex.ru has IPv6 address 2a02:6b8::186
music.yandex.ru mail is handled by 10 mx.yandex.net.
```

В данном ответе мы получили записи 3 разных типов:

- A - содержащую IPv4 адрес: 213.180.204.186;
- AAAA - содержащую IPv6 адрес: 2a02:6b8::186;
- MX - адрес почтового сервера.

Что происходит, когда какое-то приложение пытается получить доступ к `music.yandex.ru`? Если у вас на устройстве есть публичный IPv6 адрес, то получив подобный ответ приложение попытается обратиться сначала к IPv6 адресу сервера, если это не удаётся, то происходит попытка связаться с сервером по IPv4 адресу.

В современных операционных системах вопросом выбора протокола занимается даже не само приложение, а компонент операционной системы. Приложение может запросить, например, TCP соединение с узлом `music.yandex.ru` и операционная система сама найдёт нужный IP адрес и свяжется по одному из доступных протоколов, будь то IPv6 или IPv4. Приложение совершенно не интересует какой протокол будет использован на нижних уровнях. Что это значит для нас? То, что мы можем безболезненно подменить для приложения IPv4 адрес на IPv6 адрес и каким-то магическим образом доставить этот пакет получателю.

Для примера возьмём домен `sberbank.ru`.

```console
$ host sberbank.ru
sberbank.ru has address 194.54.14.168
sberbank.ru mail is handled by 60 email12.sberbank.ru.
sberbank.ru mail is handled by 40 email11.sberbank.ru.
```

На нём также имеются почтовые MX записи, но нас они не интересуют. Мы видим одну запись типа A, которая указывает на адрес `194.54.14.168`. Т.е. приложение запросив этот адрес будет пытаться связаться с указанным ему IPv4 адресу. Как мы можем перенаправить этот запрос на наш шлюз NAT64? Всё просто. Нужно создать поддельную запись типа AAAA, которая будет указывать на наш шлюз. Вносим необходимые правки в настройки нашего DNS сервера и теперь его ответ будет немного иной:

```console
$ host sberbank.ru
sberbank.ru has address 194.54.14.168
sberbank.ru has IPv6 address 64:ff9b::c236:ea8
sberbank.ru mail is handled by 60 email12.sberbank.ru.
sberbank.ru mail is handled by 40 email11.sberbank.ru.
```

Как вы могли заметить, теперь ответ содержит AAAA запись, которая указывает на адрес `64:ff9b::c236:ea8` (`64:ff9b::194.54.14.168`). В таком случае наша операционная система обнаружив запись AAAA для запрашиваемого узла просто попытается с ним связаться по этом адресу, передавая данные на наш шлюз. Бинго! Проверим ещё раз. Теперь сайты Госуслуги, Сбербанк, ВТБ, Ростелеком и многие другие заработали!

NAT64 в связке с DNS64 позволили нам получить доступ к большей части ресурсов интернета. При этом у нас нет никакой необходимости в IPv4.

К сожалению, есть небольшой недостаток такого подхода. DNS64 ломает DNSSEC. Если вы пользуетесь этим механизмом, то можете заметить, что теперь сайты без IPv6, но имеющие DNSSEC перестали работать. Увы, починить это никак нельзя. С другой стороны, использование DNSSEC в РФ само по себе проблематично. Например, оператор, который предоставляет государственные услуги - Ростелеком, имеет сломанный DNSSEC на своём домене `rt.ru`. Лично я, когда включил проверку DNSSEC, столкнулся с проблемой доступа к личному кабинету моего провайдера. Так что DNSSEC в большинстве случаев проще отключать, а значит никаких проблем с ним на DNS64 не будет.

## CLAT

Итак. Мы восстановили доступ к большей части ресурсов интернета. Но остаётся вопрос торрентов и и некоторых других приложений, которые не используют доменные имена при своей работе и оперируют непосредственно IPv4 адресами, а значит будут обращаться непосредственно к этим адресам. Что делать в этом случае?

Итак. В нашей сети, которая работает только на протоколе IPv6 есть свой шлюз NAT64. Его можно назвать также PLAT (provider-side translator). Нам нужен IPv4 адрес. Сделаем свой транслятор адресов NAT46. Для этого создадим виртуальный интерфейс с IPv4 адресом и весь трафик, который будет направляться на него будем транслировать на наш NAT64. Такой транслятор называется CLAT (customer-side translator). Вместе CLAT и PLAT представляют собой архитектуру 464XLAT, которая позволяет передавать по сети IPv6 пакеты IPv4.

Плохая новость: CLAT необходимо устанавливать на каждое устройство в сети без IPv4. Хорошая новость: использование CLAT делает ваш доступ в интернет полноценным. Вам будут доступны все сервисы сети без каких-либо ограничений. Более того, механизм CLAT в некоторых операционных системах уже встроен.

Android поддерживает CLAT  начиная с версии 4.3 из далёкого 2013 года!!! Однако в зависимости от поставщика могут быть некоторые отличия. Например, мне не удалось использовать CLAT на старом телефоне с Android 5.0. MIUI на телефоне Poco X3 NFC не позволяет отключить IPv4 для сотовых сетей даже несмотря на выбор режима только IPv6. Наиболее свежие телефоны с Android, в том числе, умеют распознавать специальную опцию DHCPv4 и могут не получать IPv4 адреса и активировать CLAT.

iOs?

Представитель Microsoft в начале 2024 года [завил](https://techcommunity.microsoft.com/t5/networking-blog/windows-11-plans-to-expand-clat-support/ba-p/4078173) о том, что компания планирует расширить поддержку CLAT в том числе и на интерфейсы не сотовых сетей в Windows 11.

MacOS?

В различных дистрибутивов Linux можно найти пакеты, которые позволяют использовать трансляцию адресов, в виде готовых пакетов или скриптов. Трансляция обычно базируется на пакете tayga или jool. Реализация jool является более производительной, т.к. поставляется с собственным модулем ядра.

## Возможности архитектуры 464XLAT

На самом деле архитектура 464XLAT не заставляет вас использовать CLAT непосредственно на вашем устройстве. CLAT может быть установлен на ваш маршрутизатор, а PLAT у вашего провайдера или вообще где-то за пределами сети оператора в интернете. При этом между устройствами CLAT и PLAT трафик передаётся только с использованием IPv6.

Если CLAT установлен на вашем маршрутизаторе, то вы, как в настоящее время имеете внутри вашей локальной сети двойную адресацию IPv4+IPv6, но сеть вашего оператора имеет более простую архитектуру и базируется исключительно на IPv6. При этом вы не имеете каких либо заметных ограничений. Ваша сеть работает абсолютно также, как работала бы, если бы оператор использовал двойной стек протоколов IPv4+IPv6.

## Заключение

Протокол нового поколения IPv6 является полноценной заменой IPv4. Во время перехода от IPv4 к IPv6 для поддержания полноценного доступа ко всем ресурсам интернета необходимо использовать дополнительно оборудование и программное обеспечение. Однако в процессе перехода нагрузка на это оборудование будет постепенно снижаться, что выгодно отличает этот вариант от использования NAT44 на сетях провайдеров, где нагрузка на оборудование, выполняющее эти функции, только возрастает.
