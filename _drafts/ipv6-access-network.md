# Развертывание сетей доступа преимущественно на основе IPv6

Это перевод [заметки Ondřej Caletka от 21 ноября 2022 года](https://blog.apnic.net/2022/11/21/deploying-ipv6-mostly-access-networks/). Спустя 2 года статья всё ещё актуальна.с небольшими изменениями.

Двойной стек — наиболее распространенный способ развертывания IPv6 в сетях доступа. Недавний стандарт определяет сети доступа преимущественно IPv6 («IPv6-mostly»), обеспечивая подключение IPv4 только для устаревших устройств, в то время как современные устройства могут работать только с IPv6. Он уже хорошо поддерживается и позволяет операторам связи постепенно отказываться от IPv4 в сетях доступа.

Многие операторы связи пытались перевести большую часть своих сетей только на IPv6, чтобы решить проблему нехватки адресации IPv4. Для сетей абонентов это создаёт проблемы, поскольку всё ещё существует множество устаревших устройств, приложений и/или служб, которые не могут работать должным образом в среде с только IPv6. Сети с двойным стеком, возможно, являются наилучшим решением для абонентов, но при этом никак не решается проблема нехватки IPv4.

## Мобильные телефоны готовы, настольные компьютеры — нет

Состояние поддержки сетей с только IPv6 заметно отличается для разных типов устройств, или, точнее, зависит от их операционных систем. В целом, не должно быть никаких проблем с предоставлением сетей только IPv6 (с NAT64 и DNS64 для организация доступа к узлам с устаревшими IP) для мобильных операционных систем iOS и Android. В случае iOS, Apple [заставляет всех разработчиков приложений](https://developer.apple.com/support/ipv6/) публиковать приложения, которые поддерживают работу в сетях только IPv6. Для веб-сайтов, работающих только через IPv4 или сломанным двуалстэком, где IPv6 фактически не работает, есть поддержка Happy Eyeballs версии 2 ([RFC 8305](https://datatracker.ietf.org/doc/html/rfc8305)), которая обеспечивает стабильное и быстрое подключение не зависимо от состояния сети. Наконец, при подключению к компьютеру также есть механизм трансляции на стороне пользователя (Customer-Side Translator — [CLAT](<https://datatracker.ietf.org/doc/html/rfc6877#section-2>)), так что подключенное устройство получает дуалстэк, несмотря на то, что мобильная сеть может работать только с IPv6.

В случае Android движок CLAT является важной функцией, смягчающей проблемы с сетями доступа на основе только IPv6. Он позволяет немодифицированным устаревшим приложениям работать без серьёзных проблем, поскольку с точки зрения приложения, устройство по-прежнему подключено к сети с двойным стеком. Устройства iOS и Android работают в мобильных сетях только IPv6 по всему миру, поэтому можно с уверенностью ожидать, что серьёзных проблем возникнуть не должно.

Что касается настольных операционных систем, ситуация менее удовлетворительная. Пользователи Windows, Linux и macOS по-прежнему могут свободно устанавливать приложения из различных источников, включая устаревшие приложения, использующие устаревшие API-интерфейсы, которые работают только с IPv4. Такие приложения не будут работать, если на устройстве не будет предоставлен IPv4. В то же время движка CLAT, который бы решал эти проблемы, практически не существует. Для Linux есть [скрипт clatd](https://github.com/toreanderson/clatd), но он не является стандартной частью какого-либо распространенного дистрибутива (однако обсуждение его внедрения в NetworkManager и systemd активно ведётся в начале 2025 года — прим. пер.). В Windows есть движок CLAT, но он активируется только при прямом подключении модема WWAN к машине. Таким образом, ноутбук с Windows может подключаться к мобильным сетям, работающим только на базе IPv6, и по-прежнему поддерживать приложения, работающие только с IPv4.

Из-за этого ограничения настольных операционных систем развертывание сетей доступа только на основе IPv6 может вызвать проблемы для определенного числа пользователей. Поэтому сетевые операторы вынуждены запускать сети с двойным стеком, несмотря на то, что значительное число устройств больше не требуют IPv4.

## Отключите IPv4 с помощью параметра DHCP

Чтобы такое было возможно, недавно в [RFC 8925](https://datatracker.ietf.org/doc/html/rfc8925) была принята новая опция DHCP под номером 108, называемая «предпочтение только IPv6»(«IPv6-only Preferred»). Она позволяет указать устройству о возможности нормально работать в сети только с IPv6. Это делается путем запроса этой опции при использовании DHCP. Если сервер DHCP знает, что конкретная сеть поддерживает работу только с IPv6, он включит такую ​​опцию в ответ, что заставит клиента остановить получения адреса IPv4 через DHCP. Поэтому, несмотря на то, что сеть поддерживает двойной стек, адресация IPv4 предоставляется только устаревшим клиентам, не запрашивающим опцию «IPv6-only Preferred» DHCP. Это может помочь сократить размер пула адресов IPv4.

Мне было любопытно узнать, используется ли эта новая опция DHCP на современных устройствах. Для этого я решил измерить количество устройств, запрашивающих эту опцию в сети RIPE Meeting во время RIPE 84 в Берлине в мае 2022 года. В течение недели я собирал сообщения DHCP в файл PCAP. Затем я создал [простой анализатор](https://gist.github.com/oskar456/fa014b5847e4f4b8f7e63e10696ea0e3) с помощью [Scapy](https://scapy.readthedocs.io/en/latest/), который подсчитывает, сколько уникальных MAC-адресов запросили  опцию DHCP Preferred только для IPv6  . Вот результаты:

```console
Unique MACs: 1441
Option 108 enabled: 951 65%
```

Если предположить, что количество уникальных MAC-адресов соответствует количеству подключенных устройств, это означает, что почти  две трети устройств поддерживают работу в сетях только с IPv6. Учитывая тот факт, что RFC 8925 появился совсем недавно, это очень хороший результат. Оказалось, что параметр DHCP запрашивается не только всеми последними устройствами [Android](https://android-review.googlesource.com/c/platform/packages/modules/NetworkStack/+/1351270) и [iOS](https://support.apple.com/en-us/HT212791), но и последними устройствами с [macOS](https://support.apple.com/en-eg/HT212586) (12.0.1 и новее). Ни одна из этих платформ не имеет настроек, которые позволили бы пользователям изменять это поведение по умолчанию. Это было бы не очень хорошо, особенно в случае с macOS, где устаревшие приложения, работающие только с IPv4 всё ещё могут быть запущены.

## В macOS есть CLAT

Оказалось, что инженеры Apple учли эту проблему и фактически включили CLAT в последние версии macOS. Он активируется только при выполнении следующих условий:

* DHCP-сервер отвечает опцией «IPv6-only Preferred» и
* В объявлении маршрутизатора (RA) имеется опция PREF64 ([RFC 8781](https://www.rfc-editor.org/rfc/rfc8781.html)), содержащая префикс NAT64.

Второе требование довольно интересно, так как все предыдущие решения проблем с сетями только IPv6 на macOS использовали обнаружение префикса NAT64 с помощью DNS64 ([RFC 7050](https://www.rfc-editor.org/rfc/rfc7050.html)). Но поскольку этот тип обнаружения использует неаутентифицированный DNS, есть некоторые проблемы с безопасностью. Параметр PREF64 на другом конце, несмотря на то, что он также неаутентифицирован, разделяет судьбу с другими параметрами конфигурации и, таким образом, может быть немного более доверенным. Если оба требования выполнены, активируется CLAT, что видно в выводе команды ifconfig. Его функцию можно проверить, попытавшись выполнить ping адреса IPv4.

![Рисунок 1 — CLAT активен при сетевом подключении только по протоколу IPv6.](https://blog.apnic.net/wp-content/uploads/2022/10/Fig1-CLAT-active-on-a-IPv6-only-network-connection.-1024x651.png)

## Новая опция DHCP проста, новая опция RA — сложнее

Итак, чтобы создать правильную сеть доступа с предпочтением только IPv6, нам нужно поддерживать как новую опцию DHCP — сообщающую совместимым клиентам не использовать IPv4 — так и новую опцию RA — несущую префикс NAT64. Первая довольно легко реализуема на большинстве DHCP-серверов, поскольку RFC 8925 не требует какой-либо специальной обработки на стороне сервера. Таким образом, любой DHCP-сервер, поддерживающий пользовательские опции DHCP, можно настроить на предоставление опции 108 тем клиентам, которые её запрашивают, содержащей только 32-битное значение таймера того, как долго стек IPv4 должен оставаться деактивированным.

Что касается опции PREF64 для RA, каждый маршрутизатор должен быть обновлен для поддержки этой новой опции. К счастью, поддержка медленно появляется в программных маршрутизаторах:

* есть [реализация прототипа](https://github.com/lcolitti/radvd-pref64) на Python;
* есть [запрос на включение изменений для FRR](https://github.com/FRRouting/frr/pull/11224);
* добавлена ​​поддержка в [radvd 2.20](https://github.com/radvd-project/radvd/pull/179);
* добавлена поддержка в [odhcpd](https://github.com/openwrt/odhcpd/pull/186), используемого в OpenWRT.

## DNS64 по-прежнему необходим для Safari и iOS

Поскольку опция PREF64 RA активирует движок CLAT, возникает соблазн попробовать запустить сеть без DNS64. Весь трафик IPv4 будет принудительно проходить через движок CLAT в таком случае. Он работает без проблем на Android, а также с большинством приложений на macOS, за одним большим исключением — Safari. Каким-то образом Safari отказывается использовать движок CLAT, и без DNS64 он просто не будет загружать никакие ресурсы, поддерживающие только IPv4, ни доменные имена, ни адреса IPv4. Та же ситуация справедлива для iOS. С одним только PREF64 и без DNS64 большинство приложений не могут получить доступ к Интернету IPv4.

Это означает, что сеть IPv6-mostly должна использовать DNS64 в дополнение к NAT64, опции PREF64 RA и  опции «IPv6-only Preferred» DHCP. Это окажет некоторое влияние на устаревшие устройства, использующие сеть с предпочтением только IPv6 в режиме сети с двойным стеком. Поскольку IPv6, как правило, предпочтительнее IPv4, все приложения с поддержкой IPv6 будут предпочитать использовать NAT64 вместо собственного IPv4. Собственный IPv4 будет использоваться только в особых случаях, таких как устаревшие приложения работающие только с IPv4 или использующие адресов IPv4 напрямую. Измеряя объем собственного трафика IPv4 в сети, можно определить, происходят ли такие случаи или нет, и, возможно, в какой-то момент времени принять решение полностью отказаться от IPv4.

## Сеть с предпочтением только IPv6 выглядит многообещающе

Из моих тестов следует, что сеть с предпочтением только IPv6, выполняет свою задачу по предоставлению полноценной сети пользователям при использовании наименьшего количества ресурсов IPv4. С другой стороны, есть некоторая дополнительная сложность настройки по сравнению с традиционными сетями с двойным стеком и нет прямой экономии на ресурсах IPv4, поскольку IPv4 всё ещё должен быть развернут везде для поддержки устаревших устройств. Однако в ближайшие годы ожидается, что объём непосредственно трафика IPv4 в таких сетях снизится до уровня, когда будет разумно вообще не развертывать IPv4. В традиционных сетях с двумя стеками дефицитные адреса IPv4 назначаться большинству устройств, даже тем, которые в них не нуждаются, поэтому вероятно, необходимые пулы DHCP будут продолжать расти и дальше.
