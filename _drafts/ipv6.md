---
layout: post
title: IPv6 для тех, кто знает что такое IPv4
date: 2023-09-27 00:29:00 +0700
tags: [IPv6]
excerpt: Ликбез по IPv6 для тех, кто имеет представление о сетях IP.
published: false
---

В 2023 году люди боятся многих новых для них вещей, например, systemd, SELinux, IPv6 и др. От этих вещей люди стараются избавиться, отключить, удалить. Об этом написано во множестве любительских мануалов в интернете, коим может являться и этот. Далее речь пойдёт о протоколе интернета IP версии 6, для краткости — IPv6.

## Почему появился IPv6 и почему он именно такой

История протокола начинается в 1990-х годах уже прошлого тысячелетия. Предпосылкой появления нового протокола являлись проблемы, которые накопились при использовании IP протокола, который в дальнейшем я буду называть IPv4.

Первоочередной проблемой оказался размер адресного пространства. Во-первых, он не позволял дать отдельный каждому устройству в сети, что хоронило изначальный принцип сети интернет — «сквозную прозрачность». Этот принцип гарантирует нам то, чтобы доставить информацию от одного узла сети к другому нам никак не нужно будет модифицировать пакет с данными. В перспективе, ограничение адресного пространства вообще привело к тому, что провайдеры стали выдавать пользователям серые адреса и использовать NAT на своих мощностях.

В ходе обсуждения вопроса места размещения дополнительных бит адреса, инженеры пришли к выводу, что текущим форматом заголовка IPv4 придётся пожертвовать, т.е. новый протокол не будет иметь обратной совместимости, а, значит, его можно радикально переделать так, чтобы исправить в нём существующие недостатки и добавить новые возможности.

Единственное, что осталось общим в пакете IP — поле версии протокола. Старый протокол имеет номер «4». Значение «5» уже было зарезервировано для «Internet Stream Protocol Version 2», который так и не стал общедоступным, поэтому для нового протокола использовали следующее значение — «6».

Одна из идей расширения адресного пространства — использование переменной длины адреса. В этом направлении также были разработки, например, «IP нового поколения» — TUBA. Она описана в RFC 1347. В качестве основы в ней используется протокол ISO CLNP. Однако, даже сами авторы выражали опасение, что гибкость адресации будет в ущерб производительности. За TUBA зарезервирована 9 версия IP. Если бы разработка была признана перспективной, то вполне возможно, что сейчас внедряли бы IPv9, а не IPv6.

Так или иначе, был выбран вариант с количеством бит адреса такой, чтобы не столкнуться в ближайшие сотни лет с проблемой нехватки адресов, но при этом адрес был достаточно коротким, чтобы даже самые простые устройства нормально могли работать с подобными адресами. Конечно, если бы протокол IPv6 разрабатывался, например, в 2010 годах, то, вполне вероятно, что вместо 128 бит адреса мы бы использовали 256, т.к. возможности даже самых компактных устройств значительно выросли по сравнению с 1990-ми годами, когда протокол IPv6 только начал разрабатываться.

Если просто представляете себе, что такое IP адрес, но вы не специалист, то большинство адресов, которые вы используете - это IPv4 адреса, аналогом которых в IPv6 являются Unicast адреса. Т.е. это адреса, которые привязаны к конкретному сетевому адаптеру устройств. Из других вы могли встречать разве что адреса из диапазона `224.0.0.0/4`, а также знать о служебных адресах для широковещательных запросах внутри сети. Это адреса для многоадресной рассылки. Этот механизм переделан в IPv6 полностью, и это очень большая тема, которая явно не для первого знакомства с протоколом.

В IPv6 можно выделить три группы адресов:

- Unicast, которые могут идентифицировать конкретный интерфейс на устройстве;
- Anycast, адреса, на которые может отвечать целая группа интерфейсов;
- Multicast, адрес, который может использовать группа узлов, которая будет получать весь поток данных.

Как отмечалось ранее, в дальнейшем речь пойдёт только о Unicast адресах.

Чтобы продолжить дальнейшее чтение обязательно ознакомьтесь с тем, как записывают IPv6 адреса!!!

## Unicast адреса в IPv6

Первое, что нужно понять, что отличает IPv6 от IPv4 — это то, что ваше устройство теперь будет иметь не один IP адрес, а сразу несколько. В IPv4 подобная ситуация тоже возможна, но это не имеет большого смысла. Да, вы можете создать две сети с разными диапазонами в одном сегменте сети, но какой-то практической пользы на постоянной основе это не несёт. Иметь множество IPv6 адресов на одном сетевом адаптере — это нормально. Более того, для нормальной работы обычной сети вы не можете отказаться от Link-local адреса.

### Link-local адреса или подключаемся к сети IPv6

В IPv4 существует такое понятие, как канальные IP адреса. Это специально выделенный диапазон `169.254.0.0/16`, который используют ваши устройства, если на интерфейсе не задан IP адрес и его не удалось получить. Так поступают все версии Windows начиная... как минимум с Windows 95. Диапазон не очень популярен, поскольку сильно зависит от особенностей операционных систем. Но основная его проблема в том, что весь обмен трафика замыкается внутри одного канала. Канал — это, по сути, какое-то пространство, где узлы сети могут обмениваться между собой любыми пакетами данных без использования промежуточных узлов.

В IPv6 для link-local выделена специальная сеть `fe80::/10`. И это не простая сеть, а очень важная. Любой узел при подключении к сети IPv6 обязан себе взять адрес из этого диапазона. Даже если есть несколько сетевых адаптеров, то на каждом должен быть адрес из этого диапазона. Более того, эти адреса могут пересекаться на одном устройстве. Благодаря тому, что в таблицах маршрутизации всегда указан сетевой интерфейс устройство может легко иметь 2 и более одинаковых адреса. Возникает логический вопрос: а как тогда работать с этими адресами? Логический ответ: как пользователь — никак, просто не обращайте на них внимание. Как пользователю, эти адреса напрямую вам вряд ли понадобятся, но при желании их можно использовать с указанием сетевого интерфейса, например, на linux это выглядит так: `fe80::1%ens3`, где ens3 имя сетевого интерфейса. В Windows используется число, которое указаывает на конкретный сетевой интерфейс.

Как итог: первое, что вы увидите при включении IPv6 протокола на сетевом интерфейсе — link-local адрес. Например, если вы подключите к сети компьютер под управлением ОС Windows, то он автоматически выберет себе адреса из указанного диапазона. Если в вашей сети не будет DHCPv4 сервера, то компьютер также получит IPv4 адрес из диапазона `169.254.0.0/16`. В данном случае IPv4 и IPv6 работают примерно одинаково. При этом IPv4 адрес изменится, если в сети появится DHCP сервер, а IPv6 адрес останется и продолжит работать не зависимо от настроек сети.

Link-local адрес всегда выбирается из этого диапазона сети по определённому алгоритму, благодаря чему этот адрес для интерфейса всегда одинаковый и не меняется со временем.

Link-local адресации вполне достаточно, чтобы, например, расшарить папку или принтер в Windows. Для примера можете установить Windows 7 на виртуальные машины. Можно использовать клонирование, тогда нужно будет у клона изменить параметры сетевого интерфейса и имя машины. После запуска обоих операционных систем в единой внутренней сети машины прекрасно видят себя через сетевое окружение, в том числе даже при отключении IPv4 протокола.

Если на вашей машине активирован протокол IPv6, то даже если вы не настраивали IPv6 сети и используете Windows, то вполне вероятно, что большая часть трафика в внутри сети между устройствами через стандартные механизмы Windows ходит именно по IPv6. Например, протокол LLMNR позволяет найти IPv6 адреса устройств с использованием Multicast запросов IPv6. Именно поэтому, когда вы обращаетесь к соседнему устройству по имени, то вы с большой долей вероятности с помощью LLMNR получите его link-local адрес и обратитесь к его сетевым ресурсам именно по сети IPv6. Это просто магия IPv6!!! Вы ничего не настраивали, но уже всё работает. И это не сломается, даже если добавите вашей сети новые возможности, например, выход в сеть интернет, просто потому, что link-local адреса с вами навсегда.

Итог. Посмотрите на адреса вашего сетевого адаптера. Если там указан адрес, который начинается на `fe80:`, то это тот самый `link-local` адрес. Если он у вас есть, то протокол IPv6 активен на этом сетевом интерфейсе. Всё, что позволяет этот адрес — общаться с соседями по вашей локальной сети. Да и то, только в том случае, если у вас нет других адресов.

### Адреса Site Local или Unique Local Address (ULA)

Представьте себе ситуацию, что вы решили объединить две сети. Если у вас сеть IPv4, то вы начинаете использовать стандартные выделенные диапазоны: `10.0.0.0/8`, `172.16.0.0/12` и `192.168.0.0/16`. В IPv6 тоже есть свой аналог. Это тоже специально выделенный диапазон `fc00::/7`. При этом изначально было два выделенных диапазона для разных целей `fc00::/8` и `fd00::/8`. Однако позже их объединили в единый диапазон. При этом в большинстве случаев предпочитается использование диапазона `fd00::/8`. Например, прошивка OpenWRT для маршрутизаторов по умолчанию автоматически генерирует для сеть `fdXX:XXXX:XXXX::/48`, которую в дальнейшем будет использовать в качестве ULA адресов.

Немаловажная деталь: в отличие от IPv4, использование Side Local IPv6 адресов не означает, что ваш сетевой адаптер перестаёт пользоваться ULA адресом. Он по прежнему остаётся доступен и ваше устройство может общаться с соседями используя только его.

Как использовать эти адреса? Также, как вы используете аналогичную адресацию в IPv4. Можете просто назначить руками каждому хосту свой IPv6 адрес. При этом, благодаря тому, что запить IPv6 адреса можно сократить, можно добиться ещё более локаничной записи адреса, чем в IPv4, например, `fd3a::1`. Первая часть адреса `fd3a` — это выбранная вами сеть, `1` — адрес узла внутри сети `/64`. Да! Это тоже ключевое отличие IPv6 от IPv4. Для нормального функционирования сети IPv6 должен использоваться префикс длиной 64 бита! Если в IPv4 вы экономили адресное пространство и могли использовать разные маски сети, теперь маска по умолчанию всегда одна. Её можно изменить, но на это должна быть веская причина, которая скорее всего связана с искусственно созданными ограничениями. Если у вас возникает желание изменить маску сети в IPv6, значит вы что-то неправильно делаете или что-то делает неправильно тот, кто выделил вам сеть.

Прописывать руками обычно не очень хорошая идея. Для IPv4 чтобы получить адрес у нас есть единственный способ — спросить у сети, а не может ли она предоставить мне IPv4 адрес. Этот механизм называется DHCP. В IPv6 пошли дальше. Если ваша сеть нуждается в ULA адресах, то она точно будет использовать маршрутизатор для связи с другими сетями. Для того, чтобы маршрутизация работала, клиенты должны иметь адреса из сети маршрутизатора. Поэтому маршрутизатор IPv6 умеет отвечать на специальные Milticast адреса и сообщает своим клиентам, что он в рабочем состоянии, что он может маршрутизировать и какие адреса при этом использует. Клиенты на основании этой информации могут автоматически сгенерировать для себя уникальный адрес из предоставленной сети и пользоваться ей, при чём с возможностью маршрутизации.

DHCP в IPv6 тоже не обошли стороной, поскольку это очень полезный инструмент. Маршрутизатор может передать своим клиентам, что за IPv6 адресом необходимо обратиться к DHCP серверу. Также он может передать, что за остальными параметрами сети также нужно обращаться к DHCP серверу. DHCP теперь не обязан предоставлять вам адрес, но всё ещё может подсказать вам где искать те или иные сервисы в сети. Да и, вообще, DHCP становится не обязательным. Даже без него сеть IPv6 способна работать просто при наличии маршрутизатора.

Итог. Снова посмотрите на адреса на вашем сетевом адаптере. Если там присутствуют адреса из диапазона `fdXX:` или `fcXX`, то ваше устройство может общаться по сети не только с соседями, но ещё и через маршрутизаторы вашей локальной сети. Эти адреса могут появиться автоматически, если ваш маршрутизатор поддерживает IPv6.

### Глобальные адреса IPv6 (GUA)

Самый востребованный тип Unicast адресов в интернет — Global Unique Address. Только адреса из этой группы могут маршрутизироваться в интернете. Если вы собираетесь использовать интернет, то вы обязаны иметь адрес из этого диапазона.

По своей сути эти адреса для пользователя ничем не отличаются от ULA, за главным исключением. Пакеты с адресом источника из GUA маршрутизируются в интернете.

Таким образом, GUA — это как минимум третий адрес, который может быть присвоен вашему сетевому интерфейсу наряду с Link-local и ULA.

Итог. В настоящее время выделяются адреса из диапазонов `2XXX:` и `3XXX:`. Проверьте свой сетевой интерфейс. Если на нём присутствует адрес, который начинается на 2 или 3, но после этого до двоеточия обязательно идёт три знака, значит ваш маршрутизатор предоставил вам GUA адрес, а значит на вашем устройстве имеется полноценный IPv6, который способен выходить в интернет.

## Откуда у меня столько IPv6 адресов?

Пользователи Windows могут открыть свойства сетевого интерфейса и ужаснуться количеству IPv6 адесов. Пользователи Linux тоже могут выполнить команду `ip a` увидеть подобное:

```console
2: enp2s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 20:23:0d:db:09:10 brd ff:ff:ff:ff:ff:ff
    inet6 2001:0db8:2023:0910:60e1:76bd:601e:fa2f/64 scope global temporary dynamic
       valid_lft 85496sec preferred_lft 2696sec
    inet6 fd23:f1a9:d8a2::cea9:b317:45a2:eb90/64 scope global temporary dynamic
       valid_lft 528157sec preferred_lft 9546sec
    inet6 fd23:f1a9::12/128 scope global dynamic noprefixroute
       valid_lft 42598sec preferred_lft 2696sec
    inet6 2001:0db8:2023:0910::12/128 scope global dynamic noprefixroute
       valid_lft 42598sec preferred_lft 2696sec
    inet6 2001:0db8:2023:0910:36e1:7563:52e3:9043/64 scope global temporary deprecated dynamic
       valid_lft 85496sec preferred_lft 0sec
    inet6 2001:0db8:2023:0910:baa2:45c8:8915:6d10/64 scope global dynamic mngtmpaddr noprefixroute
       valid_lft 85496sec preferred_lft 2696sec
    inet6 fd23:f1a9::cfab:64da:1f13:f335/64 scope global temporary deprecated dynamic
       valid_lft 441971sec preferred_lft 0sec
    inet6 fd23:f1a9::90e:a9d9:2a14:1a03/64 scope global mngtmpaddr noprefixroute
       valid_lft forever preferred_lft forever
    inet6 fe80::a33a:1d30:af11:d339/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
```

Из результатов видно, что устройство получилось 9 адресов IPv6:

1. fe80::a33a:1d30:af11:d339/64 scope link noprefixroute
2. fd23:f1a9::90e:a9d9:2a14:1a03/64 scope global mngtmpaddr noprefixroute
3. fd23:f1a9::12/128 scope global dynamic noprefixroute
4. fd23:f1a9::cea9:b317:45a2:eb90/64 scope global temporary dynamic
5. fd23:f1a9::cfab:64da:1f13:f335/64 scope global temporary deprecated dynamic
6. 2001:0db8:2023:0910:baa2:45c8:8915:6d10/64 scope global dynamic mngtmpaddr noprefixroute
7. 2001:0db8:2023:0910::12/128 scope global dynamic noprefixroute
8. 2001:0db8:2023:0910:60e1:76bd:601e:fa2f/64 scope global temporary dynamic
9. 2001:0db8:2023:0910:36e1:7563:52e3:9043/64 scope global temporary deprecated dynamic

Как уже описывалось выше, можно заметить, что первый адрес относится к `link-local` адресам. со второго по пытый отсноятся к `ULA` и с шестого по девятый к `GUA`. Как уже вам известно, адрес `link-local` был присвоен автоматически при включении протокола IPv6. А вот полученные адреса ULA и GUA можно разделить на 3 группы:

1. автоматически сформированный хостом адрес при получении анонса маршрутизатора;
2. автоматически полученный адрес от DHCPv6 сервера;
3. автоматически сформированные адреса, которые обеспечивают приватность.

### Автоматически сформированный IPv6 адрес

В IPv6 протоколе были выделенные специальные `anycast` адреса. С помощью его узел может отправить запрос в сеть и ему ответят узлы, которые подписаны на данный тип рассылки. Частным случаем данной возможности является получение адресов соседей. В качестве соседей могут выступать, например, маршрутизаторы, При подключении к сети ваш узел посылает специальный пакет и опрашивает сеть, кто в ней является маршрутизатором. В ответ они получат ответ от каждого доступного маршрутиазтора. Ответ отправляется с помощью `multicast` рассылки, т.е. ответ получат все, кто подписан на ответы на анонсы машрутизатора. Кроме этого, маршрутизаторы в сети IPv6 периодически рассылают аналогичные пакеты, которые подтверждают, что машрутизатор доступен и работает. Маршрутизатор также может отправить пакет и сообщить своим клиентам, что он прекращает работать или останавливает маршрутизацию.

Одним из ключевых параметров, которые передают машрутизаторы, это префиксы сетей, которые они обслуживают. Префикс сети, это ничто иное, как первые 64 бита адреса IPv6. Получив его, каждый узел сможет сформировать свой уникальный IPv6 адрес. Именно такими адресми являются №2 и №6 из нашего списка. Алгоритм формирования этого адеса может зависеть от операционной системы на устройства и может быть привязан к MAC адресу сетевого адаптера. Как вы понимаете, это не очень безопасно в интернете.

Одним из первых алгоритмов был модифицированый EUI-64. Что это такое? Это просто обычный MAC адрес, который преобразовали из 48 до 64 бит. А модификация — это изменение бита, говорящего о том, что MAC адрес назначен вручную. Зачем эта модификация. Да просто потому, что простые адреса вроде ::1, ::2 и прочие могли бы случайно совпасть с MAC адресом, который был присвоен какому-либо устройству легально. Благодаря модификации MAC адрес, соответствующий этим адресам однозначно говорит о ручном назначении. Инженеры просто перестраховались.

Светить MAC адресом в составе IP не очень хорошая идея. Поэтому большинство операционных систем теперь используют случайную генерацию IPv6 адрес по определённому алгоритму. Этим они гарантируют постоянство IPv6 адреса внутри выданного префикса IPv6, но при этом из этого адреса невозможно извлечть MAC адрес устройства.

Таким образом получив от маршрутизатора анонс маршрутизируемых им сетей устройство автомаически присвоило себе два адреса ULA и GUA. Эти два адреса выглядят совершенно различно. Один из адресов позволяет маршрутизировать пакеты внутри вашей сети, как это ранее вы делали в сетях, например, 10.0.0.0/8 или 192.168.0.0/16, а также получить адрес из глобальной сети.

В анонсах маршрутизатора даже можно передать адреса DNS северов, которые обслуживают вашу сеть или вообще сообщить адреса публичных DNS, которыми должны пользоваться клиенты. К сожалению, не все клиенты способны принять данный тип данных. Проблема присуща ОС Windows.

Даже если у вас пропадёт соединение с интернетом, ваш маршрутизатор оповестит все устройства о том, что GUA больше недоступен и ваши устройства продолжат общаться используя ULA адреса или даже `link-local`, если находятся в одном сегменте сети.

### Адрес, присвоенный DHCPv6 сервером

DHCP в сетях никто не отменял. Он позволяет передать много полезной информации клиентам. При этом никакого резона раздувать ответы маршрутизаторв нет. Там передаётся только минимально необходимая информация, которой достаточно, чтобы узлы могли пользоваться услугами сети. Если вам необходимо передать дополнительные сведения, например, адрес TFTP сервера, то вы, как и в сетях IPv4, можете воспользоваться DHCPv6 сервером. О том, что DHCPv6 сервер доступен в вашей сети вы можете узнать из анонса машрутизатора. Маршрутизатор может сообщить узналм, что IPv6 адрес не нужно формировать автоматически и нужно получать его от DHCP сервера. Также они могут узнать, что за дополнительными опциями, например, адерсом TFTP сервера они могут обратиться, также, к DHCP.

Обратите внимание, наличие DHCP сервера в сети IPv6 — это не обязательное условие. Он вам необходим, только если вы хотите допольнительно настроить вашу сеть. Некоторые операционные системы, например, некоторые версии Windows не могут работать нормально без дополнительной настройки в сетиях IPv6.

Если ваш узел обратился к DHCP серверу, то он вполне мог получить адреса №3 и №7 (`fd23:f1a9::12` и `2001:0db8:2023:0910::12`). Это означает, что вам в сети `/64` был выдан адрес `::12`. Таким образом вам этот адрес бы выдан DHCP.

К сожалению, большинство узлов предпочитают адрес с наименьшим адресом. Т.е. если вы выходите в интернет, то вас легко идентифицировать по адресу `2001:0db8:2023:0910::12`. Если вас это устраивает, то вы легко можете пользоваться интернетом и дальше.

### Приватный IPv6 адрес

Если предыдущие IP адреса могли предоставить вам какие-то постоянные IPv6 адреса, хоть и случайные, но вы вполне могли их использовать для своих целей. Но использовать их при сёрфинге интернета у вас вызывает дискомфорт, то для вас создан третий тип адресов. Не зависимо от того, какие постоянные адреса выданы вашему устройству, вы всегда можете получить случайный IPv6 адрес из доступных вам префиксов и использовать именно его.

Описане алгоритма находится в RFC 4941. Если описать кратко, то ваш узел динамически формирует случаный IPv6 адрес из выданного маршрутизатором диапазона и пользуется им для всех исходящих соединений. Но тут есть одна проблема. Ваше устройство может соединиться и постоянно использовать соединение. При этом оно имеет право изменить свой IPv6 адрес. Для этого старые IPv6 адреса оно помечает как `deprecated`. Когда все соединения с использованем этого адреса будут закрыты, адрес может быть удалён с сетевого интерфейса.

В приведённом варианте механизмы приватных IPv6 адресов сформировал 4 адреса: 2 ULA и 2 GUA.