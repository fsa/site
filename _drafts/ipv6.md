---
layout: post
title: IPv6 для тех, кто знает что такое IPv4
date: 2023-09-27 00:29:00 +0700
tags: [IPv6]
excerpt: Ликбез по IPv6 для тех, кто имеет представление о сетях IP.
published: false
---

В 2023 году люди боятся многих новых для них вещей, например, systemd, SELinux, IPv6 и др. От этих вещей люди стараются избавиться, отключить, удалить. Об этом написано во множестве любительских мануалов в интернете, коим может являться и этот. Далее речь пойдёт о протоколе интернета IP версии 6, для краткости — IPv6.

История протокола начинается в 1990-х годах уже прошлого тысячелетия. Предпосылкой появления нового протокола являлись проблемы, которые накопились при использовании IP протокола, который в дальнейшем я буду называть IPv4.

Первоочередной проблемой оказался размер адресного пространства. Во-первых, он не позволял дать отдельный каждому устройству в сети, что хоронило изначальный принцип сети интернет — «сквозную прозрачность». Этот принцип гарантирует нам то, чтобы доставить информацию от одного узла сети к другому нам никак не нужно будет модифицировать пакет с данными. В перспективе, ограничение адресного пространства вообще привело к тому, что провайдеры стали выдавать пользователям серые адреса и использовать NAT на своих мощностях.

В ходе обсуждения вопроса места размещения дополнительных бит адреса, инженеры пришли к выводу, что текущим форматом заголовка IPv4 придётся пожертвовать, т.е. новый протокол не будет иметь обратной совместимости. Значит можно радикально переделать IP протокол так, чтобы исправить в нём существующие недостатки и добавить новые возможности.Единственное, что осталось общим — поле версии протокола. Старый протокол имеет номер «4». Значение «5» уже было зарезервировано для «Internet Stream Protocol Version 2», который так и не стал общедоступным, поэтому для нового протокола использовали следующее значение — «6».

Ещё одна из идей расширения адресного пространства — использование переменной длины адреса. В этом направлении также были разработки, например, «IP нового поколения» — TUBA. Она описана в RFC 1347. В качестве основы в ней используется протокол ISO CLNP. Однако, даже сами авторы выражали опасение, что гибкость адресации будет в ущерб производительности. За TUBA зарезервирована 9 версия IP. Если бы разработка была признана перспективной, то вполне возможно, что мы сейчас бы внедряли IPv9.

От идеи использовать дополнительные заголовки IP для передачи дополнительных бит адреса отказались, т.к. это потребовало бы заниматься анализом этих заголовках на всех промежуточных узлах на пути следования пакетов, что привело бы с снижению производительности сети и создало излишнюю нагрузку на маршрутизаторы.

Так или иначе, был выбран вариант с количеством бит адреса такой, чтобы не столкнуться в ближайшие сотни лет с проблемой нехватки адресов, но при этом адрес был достаточно коротким, чтобы даже самые простые устройства нормально могли работать с подобными адресами. Конечно, если бы протокол IPv6 разрабатывался, например, в 2010 годах, то, вполне вероятно, что вместо 128 бит адреса мы бы использовали 256, т.к. возможности даже самых компактных устройств значительно выросли по сравнению с 1990-ми годами, когда протокол IPv6 только начал разрабатываться.

Если просто представляете себе, что такое IP адрес, а не специалист, то большинство адресов, которые вы используете - это IPv4 адреса, аналогом которых в IPv6 являются Unicast. Разве что вы могли встречать адреса из диапазона `224.0.0.0/4`. Это адреса для многоадресной рассылки. Этот механизм переделан в IPv6 полностью, и это очень большая тема, поэтому в данной заметке она не рассматривается.

Вообще, в IPv6 можно выделить три группы адресов:

- Unicast, которые могут идентифицировать конкретный интерфейс на устройстве;
- Anycast, адреса, на которые может отвечать целая группа интерфейсов;
- Multicast, адрес, который может использовать группа узлов, которая будет получать весь поток данных.

В дальнейшем будет рассмотрено только использование Unicast адресов, чего вполне достаточно, чтобы понять как настроить свой домашний маршрутизатор для работы с IPv6 вместе или в качестве полной замены IPv4.

## Unicast адреса в IPv6

Первое, что нужно понять, что отличает IPv6 от IPv4 — это то, что ваше устройство теперь будет иметь не один IP адрес, а сразу несколько. В IPv4 подобная ситуация тоже возможна, но это не имеет большого смысла. Да, вы можете создать две сети с разными диапазонами в одном сегменте сети, но какой-то практической пользы на постоянной основе это не несёт.

## Link-local адреса

В IPv4 существует такое понятие, как канальные IP адреса. Это специально выделенный диапазон `169.254.0.0/16`, который используют ваши устройства, если на интерфейсе не задан IP адрес и его не удалось получить. Так поступают все версии Windows начиная... как минимум с Windows 95. Диапазон не очень популярен, поскольку сильно зависит от особенностей операционных систем. К тому же полностью изолированные сети, которыми никто не управляет практически ушли в прошлое.

Так или иначе, если вы подключите к сети два компьютера под управлением ОС Windows, то они автоматически выберут себе адреса из указанного выше диапазона. В IPv6 есть аналогичный диапазон `fe80::/10`. Аналогичный, но не совсем. Этот адрес называют `link-local`.

Первое его ключевое отличие — любое устройство подключенное к IPv6 сети обязано иметь этот адрес. Адрес всегда выбирается из этого диапазона сети по определённому алгоритму, благодаря чему этот адрес для интерфейса всегда одинаковый и не меняется со временем. Вторая особенность — эти адреса могут быть назначены даже на два интерфейса на одном устройстве. Более того, один и тот же адрес может быть назначен на несколько сетевых интерфейсов устройства. Возникает логический вопрос: а как тогда работать с этими адресами? Логический ответ: как пользователь — никак, просто не обращайте на них внимание. Их могут использовать сетевые администраторы, но как пользователю эти адреса напрямую вам не понадобятся.

Link-local адресации вполне достаточно, чтобы расшарить папку или принтер в Windows. Для примера я установил Windows 7 на виртуальную машину и клонировал её. У клона изменил параметры сетевого интерфейса и имя машины. После запуска обоих операционных систем в единой внутренней сети машины прекрасно видят себя через сетевое окружение, в том числе даже при отключении IPv4 протокола.

Если на вашей машине активирован IPv6 адрес, то даже если вы не настраивали IPv6 сеть и используете Windows, то вполне вероятно, что большая часть трафика в вашей домашней сети между устройствами через стандартные механизмы Windows ходит именно по IPv6.

### Site Local Address
