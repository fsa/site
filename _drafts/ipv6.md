---
layout: post
title: IPv6 для тех, кто знает что такое IPv4
date: 2023-09-27 00:29:00 +0700
tags: [IPv6]
excerpt: Ликбез по IPv6 для тех, кто имеет представление о сетях IP.
published: false
---

В 2023 году люди боятся многих новых для них вещей, например, systemd, SELinux, IPv6 и др. От этих вещей люди стараются избавиться, отключить, удалить. Об этом написано во множестве любительских мануалов в интернете, коим может являться и этот. Далее речь пойдёт о протоколе интернета IP версии 6, для краткости — IPv6.

## Почему появился IPv6 и почему он именно такой

История протокола начинается в 1990-х годах уже прошлого тысячелетия. Предпосылкой появления нового протокола являлись проблемы, которые накопились при использовании IP протокола, который в дальнейшем я буду называть IPv4.

Первоочередной проблемой оказался размер адресного пространства. Во-первых, он не позволял дать отдельный каждому устройству в сети, что хоронило изначальный принцип сети интернет — «сквозную прозрачность». Этот принцип гарантирует нам то, чтобы доставить информацию от одного узла сети к другому нам никак не нужно будет модифицировать пакет с данными. В перспективе, ограничение адресного пространства вообще привело к тому, что провайдеры стали выдавать пользователям серые адреса и использовать NAT на своих мощностях.

В ходе обсуждения вопроса места размещения дополнительных бит адреса, инженеры пришли к выводу, что текущим форматом заголовка IPv4 придётся пожертвовать, т.е. новый протокол не будет иметь обратной совместимости, а, значит, его можно радикально переделать так, чтобы исправить в нём существующие недостатки и добавить новые возможности.

Единственное, что осталось общим в пакете IP — поле версии протокола. Старый протокол имеет номер «4». Значение «5» уже было зарезервировано для «Internet Stream Protocol Version 2», который так и не стал общедоступным, поэтому для нового протокола использовали следующее значение — «6».

Одна из идей расширения адресного пространства — использование переменной длины адреса. В этом направлении также были разработки, например, «IP нового поколения» — TUBA. Она описана в RFC 1347. В качестве основы в ней используется протокол ISO CLNP. Однако, даже сами авторы выражали опасение, что гибкость адресации будет в ущерб производительности. За TUBA зарезервирована 9 версия IP. Если бы разработка была признана перспективной, то вполне возможно, что сейчас внедряли бы IPv9, а не IPv6.

Так или иначе, был выбран вариант с количеством бит адреса такой, чтобы не столкнуться в ближайшие сотни лет с проблемой нехватки адресов, но при этом адрес был достаточно коротким, чтобы даже самые простые устройства нормально могли работать с подобными адресами. Конечно, если бы протокол IPv6 разрабатывался, например, в 2010 годах, то, вполне вероятно, что вместо 128 бит адреса мы бы использовали 256, т.к. возможности даже самых компактных устройств значительно выросли по сравнению с 1990-ми годами, когда протокол IPv6 только начал разрабатываться.

Если просто представляете себе, что такое IP адрес, но вы не специалист, то большинство адресов, которые вы используете - это IPv4 адреса, аналогом которых в IPv6 являются Unicast адреса. Т.е. это адреса, которые привязаны к конкретному сетевому адаптеру устройств. Из других вы могли встречать разве что адреса из диапазона `224.0.0.0/4`, а также знать о служебных адресах для широковещательных запросах внутри сети. Это адреса для многоадресной рассылки. Этот механизм переделан в IPv6 полностью, и это очень большая тема, которая явно не для первого знакомства с протоколом.

В IPv6 можно выделить три группы адресов:

- Unicast, которые могут идентифицировать конкретный интерфейс на устройстве;
- Anycast, адреса, на которые может отвечать целая группа интерфейсов;
- Multicast, адрес, который может использовать группа узлов, которая будет получать весь поток данных.

Как отмечалось ранее, в дальнейшем речь пойдёт только о Unicast адресах.

Чтобы продолжить дальнейшее чтение обязательно ознакомьтесь с тем, как записывают IPv6 адреса!!!

## Unicast адреса в IPv6

Первое, что нужно понять, что отличает IPv6 от IPv4 — это то, что ваше устройство теперь будет иметь не один IP адрес, а сразу несколько. В IPv4 подобная ситуация тоже возможна, но это не имеет большого смысла. Да, вы можете создать две сети с разными диапазонами в одном сегменте сети, но какой-то практической пользы на постоянной основе это не несёт. Иметь множество IPv6 адресов на одном сетевом адаптере — это нормально. Более того, для нормальной работы обычной сети вы не можете отказаться от Link-local адреса.

### Link-local адреса или подключаемся к сети IPv6

В IPv4 существует такое понятие, как канальные IP адреса. Это специально выделенный диапазон `169.254.0.0/16`, который используют ваши устройства, если на интерфейсе не задан IP адрес и его не удалось получить. Так поступают все версии Windows начиная... как минимум с Windows 95. Диапазон не очень популярен, поскольку сильно зависит от особенностей операционных систем. Но основная его проблема в том, что весь обмен трафика замыкается внутри одного канала. Канал — это, по сути, какое-то пространство, где узлы сети могут обмениваться между собой любыми пакетами данных без использования промежуточных узлов.

В IPv6 для link-local выделена специальная сеть `fe80::/10`. И это не простая сеть, а очень важная. Любой узел при подключении к сети IPv6 обязан себе взять адрес из этого диапазона. Даже если есть несколько сетевых адаптеров, то на каждом должен быть адрес из этого диапазона. Более того, эти адреса могут пересекаться на одном устройстве. Благодаря тому, что в таблицах маршрутизации всегда указан сетевой интерфейс устройство может легко иметь 2 и более одинаковых адреса. Возникает логический вопрос: а как тогда работать с этими адресами? Логический ответ: как пользователь — никак, просто не обращайте на них внимание. Как пользователю, эти адреса напрямую вам вряд ли понадобятся, но при желании их можно использовать с указанием сетевого интерфейса, например, на linux это выглядит так: `fe80::1%ens3`, где ens3 имя сетевого интерфейса. В Windows используется число, которое указаывает на конкретный сетевой интерфейс.

Как итог: первое, что вы увидите при включении IPv6 протокола на сетевом интерфейсе — link-local адрес. Например, если вы подключите к сети компьютер под управлением ОС Windows, то он автоматически выберет себе адреса из указанного диапазона. Если в вашей сети не будет DHCPv4 сервера, то компьютер также получит IPv4 адрес из диапазона `169.254.0.0/16`. В данном случае IPv4 и IPv6 работают примерно одинаково. При этом IPv4 адрес изменится, если в сети появится DHCP сервер, а IPv6 адрес останется и продолжит работать не зависимо от настроек сети.

Link-local адрес всегда выбирается из этого диапазона сети по определённому алгоритму, благодаря чему этот адрес для интерфейса всегда одинаковый и не меняется со временем.

Link-local адресации вполне достаточно, чтобы, например, расшарить папку или принтер в Windows. Для примера можете установить Windows 7 на виртуальные машины. Можно использовать клонирование, тогда нужно будет у клона изменить параметры сетевого интерфейса и имя машины. После запуска обоих операционных систем в единой внутренней сети машины прекрасно видят себя через сетевое окружение, в том числе даже при отключении IPv4 протокола.

Если на вашей машине активирован протокол IPv6, то даже если вы не настраивали IPv6 сети и используете Windows, то вполне вероятно, что большая часть трафика в внутри сети между устройствами через стандартные механизмы Windows ходит именно по IPv6. Например, протокол LLMNR позволяет найти IPv6 адреса устройств с использованием Multicast запросов IPv6. Именно поэтому, когда вы обращаетесь к соседнему устройству по имени, то вы с большой долей вероятности с помощью LLMNR получите его link-local адрес и обратитесь к его сетевым ресурсам именно по сети IPv6. Это просто магия IPv6!!! Вы ничего не настраивали, но уже всё работает. И это не сломается, даже если добавите вашей сети новые возможности, например, выход в сеть интернет, просто потому, что link-local адреса с вами навсегда.

Посмотрите на адреса вашего сетевого адаптера. Если там указан адрес, который начинается на `fe80:`, то это тот самый `link-local` адрес. Если он у вас есть, то протокол IPv6 активен на этом сетевом интерфейсе. Всё, что позволяет этот адрес — общаться с соседями по вашей локальной сети. Да и то, только в том случае, если у вас нет других адресов.

### Адреса Site Local

Представьте себе ситуацию, что вы решили объединить сети двух организаций. В ситуации, когда у вас есть IPv4 сеть, то ваши локальные сети настроены на один из выделенных стандартных диапазонов: `10.0.0.0/8`, `172.16.0.0/12` и `192.168.0.0/16`. В IPv6 есть свой ответ. Если вы не планируете, что узлы, которым вы назначаете адреса никогда не будут выходить в сеть интернет, то можете использовать специально выделенный диапазон `fc00::/7`.
