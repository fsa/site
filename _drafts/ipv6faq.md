# Вопросы-ответы по IPv6

Ваш интернет работает без сбоев, и вы думаете: «IPv4 меня полностью устраивает, зачем этот IPv6?» Логично, ведь всё и так работает. Но есть одна загвоздка. Адресов IPv4-адреса довольно мало, особенно если учесть на сколько вырос интернет за последние десятилетия. Провайдеры вынуждены использовать дополнительно оборудование (например, CGNAT), чтобы дать доступ в сеть IPv4 всем пользователя. Адреса, как дефицитный товар, перепродаются и увеличивается стоимость их аренды. Например уже сейчас чтобы получить полноценный доступ в интернет по IPv4 провайдеры в РФ просят от 20 до 150 рублей в месяц за «белый» IPv4 адрес. Это означает, что вы не будете делить этот адрес с другими пользователями, а также не будете использовать дополнительное оборудование провайдера, которое может заметно ухудшить качество доступа (скорость скачивания и «пинг»). Сети 5G, спутниковый интернет требуют ещё большего количества адресов, без расширения адресного пространства невозможно разворачивать такие сети. Можно подумать, что это катастрофа! Но, на самом деле нет. Инженеры уже давно озаботились проблемой нехватки IPv4, ещё тогда, когда этой проблемы не было, но расчёты показывали, что с этой проблемой мы столкнёмся в ближайшие годы. В результате появился протокол, сейчас известный как IPv6. Он решает проблему нехватки адресов, которых теперь хватит на все ваши гаджеты, от умных лампочек до роботов-пылесосов. В этой статье я простыми словами объясню, почему IPv6 — это не сложная ерунда, а наш шанс сделать интернет быстрее, дешевле и готовым к будущему. Готовы узнать, что вы теряете, оставаясь с IPv4?

## Зачем был создан новый протокол IPv6?

В первую очередь, новый протокол призван решить основную проблему IPv4 — острую нехватку адресного пространства.

## Почему инженеры просто не расширили адресное пространство IPv4? Зачем было делать новый протокол?

Заголовок пакетов IPv4 имеет чёткую структуру. В нём просто не оказалось места для дополнительных бит адреса, любое изменение заголовка пакеты вызывает несовместимость со старым протоколом и требует обновление программного обеспечения на всём парке устройств. Так разработчики пришли к выводу, что совместимостью со старым протоколом IPv4 придётся пожертвовать. Но если ломается совместимость, то почему бы попутно не сделать протокол максимально эффективным и учесть все ошибки, которые были выявлены при эксплуатации старого протокола.

## Почему новый протокол имеет версию 6, а не 5, например?

Так сложилось исторически. Всё дело в заголовке IP пакета. И IPv4 и IPv6 имеют в своей структуре поле «версия». Номер 5 был занят ранее и за новым протоколом закрепили следующую свободную версию — 6.

## IPv6 не очень популярен, я лучше подожду когда разработают IPv7 или IPv9

На самом деле подобные разработки уже велись. Например, протокол TUBA, где адрес вообще может быть переменной длины. Но даже сами авторы выражали сомнения в том, что протокол будет достаточно эффективным. Если бы разработку признали перспективной, то сейчас говорили бы о переходе на IPv9. Но сейчас речь идёт именно о протоколе IPv6, который доказал свою эффективность.

Полный список зарезервированных версий IP представлен [на сайте IANA](https://www.iana.org/assignments/version-numbers/version-numbers.xhtml). Так что если ждать замену IPv6, то в 2025 году это будет как минимум IPv10!

## Да у меня есть куча устройств, которые не умеют использовать ничего, кроме IPv4

Использование протокола IPv6 не означает обязательного полного отказа от IPv4. Вы можете использовать оба протокола IPv4 и IPv6 одновременно (дуалстэк). Более того, существуют технологии, которые позволят вам организовывать островок IPv4 даже если вся ваша сеть или сеть вашего провайдера работает исключительно на IPv6. Ваш провайдер может иметь сеть исключительно на IPv6, но предоставлять вам доступ в сеть IPv4 через специальные шлюзы NAT64, которые по своему принципу работы похожи на используемые сейчас CGNAT. При этом ваша домашняя сеть при правильной настройке маршрутизатора может иметь по прежнему «серую» адресацию IPv4, такую же, какую вы используете сейчас, а также предоставлять доступ в сеть IPv6 без каких либо посредников. Таким образом ваши IPv4-устройства — принтеры, лампочки, пылесосы —  могут продолжать работать как и раньше.

## IPv6 несовместим с IPv4 напрямую, нужны сложные штуки вроде дуалистеки, туннелирования или NAT. Разве это не делает внедрение слишком сложным?

Да, IPv6 и IPv4 отличаются, и они не могут «разговаривать» напрямую, как старый и новый WiFi. Но это не значит, что внедрение IPv6 — это какой-то технический кошмар. На самом деле, переход на IPv6 проще, чем кажется, и не требует от вас гениальности сисадмина. Новый протокол умеет всё тоже, то и старый. При этом можно просто отобразить весь интернет IPv4 и сделать его полностью доступным из IPv6 сети. Для этого даже не нужно ничего нового изобретать, а просто пользоваться давно известным механизмом, который в IPv4 используется повсеместно — NAT.

Двойной стек (dual-stack) — это просто и уже работает. Большинство современных маршрутизаторов, смартфонов и компьютеров поддерживают оба протокола — IPv4 и IPv6 — одновременно. Это называется двойной стек, и он включается автоматически, если ваш провайдер даёт IPv6. Ваши старые устройства будут использовать IPv4, а новые — IPv6, без конфликтов. Никаких сложных настроек не нужно: если роутер современный, он уже готов к этому. Для дома это идеальный вариант.

Туннелирование (например, 6in4) необходимо только в тех случаях, когда вы попали в сеть, где IPv6 ещё не поддерживается. Т.е. находясь в сети IPv4 вы можете получать доступ к ресурсам на IPv6. Это не самый хороший вариант, поскольку качество работы IPv6 сильно зависит от IPv4 и оборудования, которое обеспечивает туннель. Но он позволяет получить доступ к IPv6 ресурсам там, где его нет.

NAT64 — это специальный механизм трансляции, который нужен только во время перехода от IPv4 к IPv6, который обеспечивает доступ устройств, которые работают в сети где IPv4 нет, но при этом они могут иметь доступ ко всем сервисам, которые работают на этом протоколе. В некотором смысле это переосмысление тех костылей, которые до сих пор поддерживают IPv4 на плаву. В большинстве случаев NAT64 занимается ваш провайдер. Вам ничего не нужно настраивать (но при желании можно сделать это и самому), а только пользоваться, ровно также как вы сейчас можете использовать CGNAT даже не задумываясь об этом. Но IPv4 заставляет провайдеров использовать CGNAT, чтобы экономить адреса, но это замедляет интернет для игр, видеозвонков или умных устройств. Плюс, за «белый» IPv4-адрес часто нужно платить. Даже если вы считаете, что не платите за IPv4, то часть вашей абонентской платы уходит на IPv4 и поддержание этих коробок с CGNAT. IPv6 даёт бесплатные адреса и убирает CGNAT, делая сеть быстрее и проще. Да, переходные механизмы могут звучать сложно, но они работают незаметно, чтобы ваш интернет не тормозил. NAT64 делает тоже самое, но позволяет устройствам полностью избавиться от IPv4. Немаловажный факт. Шлюзы NAT64 нужны только пока осуществляется переход от IPv4 к IPv6. Чем больше сервисов будет работать с IPv6, тем меньше будет необходимость в NAT64. CGNAT напротив нужен для нормальной работы. И нагрузка на него будет расти с ростом потребления трафика пользователями. А их становится всё больше и больше, количество устройств с IP адресами постоянно растёт, например, любое устройство IoT требует адреса.

Кстати, все современные мобильные ОС (Android и iOs) могут работать в сетях исключительно IPv6. Они умеют обнаруживать NAT64 в сети и использовать его для доступа к ресурсам IPv4. Вы не заметите никаких изменений, если просто отключите IPv4 протокол для соединения с вашим провайдером и оставите только IPv6. Вы даже сможете по WiFi раздать свой интернет, где будет работать дуалстэк.

## NAT защищает, а в IPv6 ты виден всем в интернет

Некоторые думают, что IPv4 с NAT безопаснее, но это миф — NAT не заменяет файервол. Принцип сквозной прозрачности, который был основополагающим при разработке интернет, но был похоронен из-за нехватки адресов IPv4, совершенно не означает, что пакеты могут бесконтрольно гулять по интернету. В IPv6 устройства могут иметь глобальные адреса, но современные маршрутизаторы блокируют нежелательный трафик по умолчанию. Настройка IPv6 так же проста и безопасна, как IPv4. Ваше устройство по прежнему может быть под защитой вашего маршрутизатора, но при этом совершенно легально иметь свой адрес в интернете.

## IPv6 адреса длинные, непонятные и их сложно вводить вручную

Несомненно, IPv6 адреса длиннее, чем адреса IPv4. С этим ничего не поделаешь, это плата за расширение адресного пространства. К тому же вводить IPv6 адреса практически нет необходимости. Благодаря механизму SLAAC ваше устройство самостоятельно может получать IPv6 адрес если в вашей сети есть маршрутизатор.

Почему была выбрана шестнадцатеричная система исчисления, а не десятичная, как было в IPv4? Такая запись более компактная, с учётом длины адреса есть большая экономия. Большинство технических специалистов знают про эту систему и пользуются ей. При просмотре дампов пакетов при отладке сети эти адреса явно видны.

На сколько часто вы вводите IPv4 адреса вручную обращаясь к ресурсам в интернете? Мой опыт говорит, что IPv4 практически не используются напрямую. Для подключения к узлам как правило используются доменные имена. Так же и с IPv6. Вам практически не понадобится вводить IPv6 адреса вручную. А если вы всё-таки решились заставить других вводить ваш IPv6 адрес, то у вас есть возможность выбрать такой IPv6 адрес, который очень сильно можно сократить.

Для IPv6 адресов выработаны чёткие правила по сокращению. Например, вы можете воспользоваться тем, что 64 бита в IPv6 адресе используются как идентификатор интерфейса и выбрать короткое значение, например, «1». Тогда полный адрес вашего устройства сократится почти в 2 раза, например, `2001:db8:1234:8421::1`. Если в получите в своё распоряжение сеть `/48` от вашего провайдера, то для серверов вы можете выбрать более короткий адрес: `2001:db8:1234::1`. Уже не так страшно? А какие возможности есть для локальной адресации? Для локальной сети используется адресация «fd00::/8». Это означает, что вы можете выбрать ещё более короткие адреса, например, `fd12::/48`. Так, например, ваш маршрутизатор вполне может иметь адрес `fd12::1`! Это куда компактнее привычных `192.168.1.1`. Да, по хорошему 40 бит в диапазоне `fd00::/8` должны быть выбраны случайно, чтобы вы случайно не выбрали такую же адресацию, как и в сети, с которой захотите в будущем объединиться. Но, например, как часто вы связывали напрямую домашнюю сеть с другой домашней сетью? Попробуйте для домашней сети использовать короткую адресацию и посмотрите на сколько часто вам нужно будет вводить адрес вручную!

## Куда пропала маска сети?

Если вы когда-нибудь настраивали устройства в сети IPv4, то наверняка знаете о том, что кроме IPv4 адреса необходимо знать ещё и маску сети. Например, очень часто в домашних сетях используется следующая комбинация: `192.168.1.0`/`255.255.255.0`. Эту запись можно сократить до такой: `192.168.1.0/24`. Значение 24 указывает на количество бит со значением `1` в маске сети. Такой способ запись более ограничен, т.к. не позволяет использовать маску сети с разрывами. А вы вообще на практике встречали такую маску?

В IPv6 маска сети, по большому счёту, утратила свой смысл. Любая сеть IPv6 обычно использует 64 бита как адрес сети и другие 64 бита как адрес интерфейса. Т.е. любая сеть имеет длину маски сети `/64`. Это не жёсткое правило, но лучше его придерживаться. Так, при указании длины маски сети от 65 и больше в вашей сети не сможет работать SLAAC. Уменьшение значения не имеет практического смысла, т.к. даже в сети `/64` вы имеете многократно адресов больше, чем сейчас во всём интернете адресов IPv4.

Однако в IPv6 появилось новое понятие, которое перекликается с маской сети. Это так называемый префикс сети. Согласно рекомендациям RIPE NCC (bcop-690) каждому пользователю необходимо выделять сеть размером `/48`. Однако некоторые операторы хотят отделить услуги для бизнеса и домашние сети, поэтому разрешено уменьшать размер сети для домашних пользователей до `/56`. В данном случае `/48` и `/56` к маске сети не имеет отношения. Эти значения показывают сколько бит в выданном префиксе вы не можете изменять, всё остальное можно использовать. По сути в ваше распоряжение вам выдаётся 65536 или 256 сетей `/64`. Для большинства этого вполне достаточно, чтобы строить сети без применения NAT. Наиболее крупные игроки, вроде Google или Yandex могут получить в своё распоряжение сеть ещё большего объёма.
