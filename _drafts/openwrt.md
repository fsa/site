---
layout: post
title: IPv6 дома с помощью OpenWRT
date: 2023-09-02 03:00:00 +0700
tags: [IPv6, OpenWRT]
excerpt: Заметка о том, как крут IPv6, если у тебя есть маршрутизатор с отменной прошивкой, например, OpenWRT.
published: false
---

Очень хотелось бы выразить свой восторг от протокола IPv6 и свободной прошивке для маршрутизаторов OpenWRT. Именно они соблюдают все принципы сети интернет: свободность и сквозную доступность! Свободность, означает, что вы можете пользоваться сетью с любого вашего устройства, даже своего собственного, вам достаточно поддерживать протоколы интернета. Сквозная доступность, означает, что вы должны иметь возможность связаться с любым необходимым вам устройством напрямую без посредников. На вашем пути могут быть средства защиты, но ваши устройства знаю как правильно направить свой трафик, чтобы он прошёл. Все промежуточные узлы просто перенаправляют пакеты без какой-либо модификации.

История началась в далёком... августе 2022 года, когда я решил покопаться в настройках своего CPE (аббревиатура от англ. customer premises equipment — телекоммуникационное оборудование). Как оказалось, в настройках WAN можно было включить IPv6. Я включил его, и, о чудо, мне предоставили префикс `/56`. Экономно. Я потыкался в IPv6 адреса и обнаружил, что теперь я могу обращаться к ним напрямую. К тому же с IPv6 я пытался разобраться давно, ещё в 2015 году. Тогда я слабо представлял что это, но уже пробовал экспериментировать на своём веб-сервере.

Очень быстро я нашёл сообщество тех, кто также как я интересуется темой IPv6. Дальше я глубже изучал тему IPv6, делал разные эксперименты, например, создавал на виртуальных машинах [сеть IPv6 с доступом к IPv4 с помощью NAT64 и DNS64)](https://tavda.net/nat64-dns64). Писал о том, [с чем столкнулся при переходе на IPv6](https://habr.com/ru/articles/721630/), а также о том [как настроить VPN с поддержкой IPv6](https://habr.com/ru/articles/752866/).

Первая проблема, которая обнаружилась — CPE просто мало что умеет делать с IPv6. Всё, что оно умеет, раздавать сеть `/64` с помощью SLAAC из полученного от провайдера `/56`, раздаёт свой фиксированный ULA `/64`, также, с помощью SLAAC. Никаких брандмауэров, DNS и, тем более, делегирования префиксов, не предусмотрено.

Попутно, выяснил ещё одну проблему. Ростелеком, видимо, включил IPv6, чтобы иметь возможность снизить нагрузку на свои CGNAT, ведь Youtube прекрасно работает через IPv6, а трафика создаёт очень много. Но, ввиду урезанного функционала CPE, они просто запретили все входящие соединения в сторону абонента, дабы обезопасить его устройства.Открыть TCP соединение со своего IPv6 адреса можно, но доступа к своему адресу ни по TCP, ни, даже, для ответных UDP, невозможно получить. Всё выглядит ровно так, как при использовании NAT, но ещё хуже, потому что UDP совсем не работает. Так Ростелеком похоронил главную фишку IPv6, которую в IPv4 похоронили уже давно с помощью NAT, — сквозную прозрачность. Более того, похороненная сквозная прозрачность позиционируется многими, как средство безопасности, которая по факту им не является, а является лишь костылём, который призван решить проблему ограниченного адресного пространства, а вопросы безопасности решаются на том же уровне брандмауэром, что Ростелеком и сделал, но более жёстко.

Все попытки добиться от технической поддержки решения проблемы разбивается о стену. Просто записывают твой номер телефона и потом перезванивает специалист и пытается уболтать закрыть заявку. При этом твердят как попугаи, что IPv6 они не предоставляют.

Именно поэтому первые свои попытки изучить как будут вести себя устройства в сети IPv6 я выполнял с помощью туннельного брокера Route48 и виртуальных машин. Одну из машин использовал в качестве маршрутизатора, а другие в качестве клиентов. Первые опыты показали, что вполне можно пользоваться интернет имея у себя только IPv6 адреса на сетевом интерфейсе. Конечно, для доступа к IPv4 при этом необходимо использовать шлюз. По сути в стандартной схеме доступа для дома обычный NAT44 заменяется на NAT64.

В один прекрасный день один из пользователей сообщества предложил мне помочь с приобретением маршрутизатора. Выбор пал на модель с WiFi 5, что меня не очень радовало, хотелось попробовать WiFi 6. С другой стороны CPE от Ростелеком неплохо справляется с WiFi в квартире даже не имея внешних антенн. Поэтому я согласился на такой вариант. К тому же модель маршрутизатора была выбрана не просто так. На неё очень легко установить OpenWRT даже через стандартный интерфейс без использования режима аварийного восстановления или других танцев с бубном.

<https://alexskra.com/blog/dynamc-dnsddns-with-openwrt-and-cloudflare/>
