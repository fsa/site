---
layout: post
title: SSH
date: 2023-05-18 23:15:00 +0700
tags: [SSH]
excerpt: Небольшая заметка о том, что можно делать с помощью SSH.
---

В данной заметке рассматривается использование клиента и сервера SSH на базе Linux, однако заметка может быть полезна и для пользователей других операционных систем. Не исключено, что позже тут появятся дополнения по использованию Putty или других программ в ОС Windows.

Как гласит википедия, «SSH — сетевой протокол прикладного уровня, позволяющий производить удалённое управление операционной системой и туннелирование TCP-соединений (например, для передачи файлов). Схож по функциональности с протоколами Telnet и rlogin, но, в отличие от них, шифрует весь трафик, включая и передаваемые пароли. SSH допускает выбор различных алгоритмов шифрования. SSH-клиенты и SSH-серверы доступны для большинства сетевых операционных систем». Когда ты первый раз ты знакомишься с ним, то, скорее всего, для тебя он представляется как средство для доступа к удалённому серверу. В первую очередь, так оно и есть. Однако его возможности намного шире.

Что может заменить протокол SSH:

- telnet — обеспечить доступ к терминалу удалённой машины по шифрованному каналу;
- ftp — обеспечить обмен файлами с удалённой машиной по шифрованному каналу и без необходимости обходить ограничения, которые присущи ftp при работе через NAT и прокси;
- проброс портов — обеспечить доступ к портам с локальной машины или её сети на порты, которые доступы удалённой машине;
- socks-прокси — обеспечить локальное устройство или целую сеть socks-прокси через удалённую машину;
- выполнение команд на удалённой машине из скриптов локальной машины.

Вполне возможно, что это не полный список возможностей SSH.

Самое главное, что SSH обеспечивает безопасность соединения с удалённой машиной с помощью современных алгоритмов шифрования. Вся пересылаемая информация между узлами находится внутри зашифрованного туннеля.

## Как работает SSH

SSH, как не трудно догадаться, работает аналогично telnet в режиме точка-многоточка. В этом режиме есть некоторый узел, к которому могут подключаться другие узлы. При этом на главном узле устанавливается сервер. Для подключения к нему используются клиентами.

В Linux системах сервер обозначается как `sshd`, что означает SSH демон (Daemon), что в терминологии Windows означает — SSH служба. Клиент SSH — `ssh`. Все необходимые настройки для клиента и сервера, обычно, в Linux системах, хранятся в папке `/etc/ssh`. По префиксу имени файла можно догадаться к клиенту или серверу имеет отношение файл настройки. Все настройки имеют глобальный характер, т.е. актуальны для всех пользователей устройства.

Кроме глобальных настроек, каждый из пользователь может хранить свою конфигурацию в домашней директории в папке `.ssh`. Что можно найти в этой директории:

Файл `config` — файл настройки клиента.

Файл `authorized_keys` содержит список ключей для доступа к этому пользователю через сервер `sshd` на этой машине. Обычно этот файл отсутствует, но если вы хотите использовать при подключении к данной машине под данным пользователем не только имя пользователя и пароль, но и ключ, то этот файл должен быть создан.

Файл `known_hosts` содержит список ключей для хостов, к которым ранее уже было произведено подключение. Это один из инструментов безопасности. При первом подключении к серверу вы получаете подпись его ключа доступа, которую в дальнейшем будете использовать для проверки легитимности хоста. При повторном подключении эти данные позволяют проверить, что это именно тот сервер, к которому вы подключались. Если вы при подключении к серверу получаете ошибку, возможно в ваш сеанс подключения желает кто-то вклиниться с целью дешифровки передаваемых данных. Если вы не перестраивали сервер, то это будет для вас знаком, что доверять серверу нельзя.

Файлы `id_*` содержат закрытые ключи доступа для текущего устройства. Вместо `*` в имени файла присутствует имя используемого алгоритма шифрования. Ключей может быть несколько для каждого запрошенного алгоритма шифрования. Эти файлы должны храниться в полной секретности. Никому их передавать нельзя. На ключи доступа можно установить пароль, без которого невозможно будет воспользоваться этим ключом. В таком случае даже в случае утечки ключа воспользоваться им будет невозможно без знания пароля.

Файлы `id_*.pub` содержат публичные ключи доступа, которые используются для подключения к другим устройствам. Вместо `*` в имени файла присутствует имя используемого алгоритма шифрования, которые предоставляет удалённое устройство при подключении. Ключей может быть несколько для каждого доступного алгоритма шифрования.

Кроме этого, имена публичных ключей шифрования могут быть любыми. В этом случае при подключении нужно прямо указать какой файл вы будете использовать при подключении к удалённой машине. Эти файлы также можно хранить в этой папке.

```bash
ssh-keygen -t ed25519
```

```bash
ssh-copy-id -i .ssh/id_ed25519
```

Если есть проблема с подключением, при подключении активируем вывод диагностических сообщений.

```bash
ssh -v gitea@gitea.example
```

To create a systemd ssh-agent service, you need to create a file in ~/.config/systemd/user/ssh-agent.service because ssh-agent is user isolated.

```systemd
[Unit]
Description=SSH key agent

[Service]
Type=simple
Environment=SSH_AUTH_SOCK=%t/ssh-agent.socket
ExecStart=/usr/bin/ssh-agent -D -a $SSH_AUTH_SOCK

[Install]
WantedBy=default.target
```

Add
SSH_AUTH_SOCK="${XDG_RUNTIME_DIR}/ssh-agent.socket"
to ~/.config/environment.d/ssh_auth_socket.conf.
Finally enable and start this service.
systemctl --user enable --now ssh-agent
And, if you are using ssh version higher than 7.2.
echo 'AddKeysToAgent  yes' >> ~/.ssh/config
This will instruct the ssh client to always add the key to a running agent, so there's no need to ssh-add it beforehand.
Note that when you create the ~/.ssh/config file you may need to run:

chmod 600 ~/.ssh/config
or

chown $USER ~/.ssh/config
Otherwise, you might receive the Bad owner or permissions on ~/.ssh/config error.

Host my_server
ForwardAgent yes
