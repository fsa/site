---
layout: post
title: Symfony
date: 2024-02-14 00:10:55 +0700
tags: [PHP]
excerpt: PHP фреймворк Symfony.
published: false
---
Долгое время не решался попробовать фреймворки. Писал свой, который должен был быть лучше, чем у других. Наверно многие так делают. Пока писал код, разбирался что и как устроено у других. И настал тот момент, когда мне надоело постоянно переделывать код своих проектов под новую версию своего фреймворка. А переделывать часто нужно было очень много.

К тому времени, как я решился попробовать фреймворки, у меня был выбор из двух мастодонтов: Laravel и Symfony. Laravel попробовал первым. Но он показался мне несколько перегруженным. Symfony же привлёк тем, то он модульный. Многие из его компонентов могут работать отдельно от фреймворка. К тому же часть компонентов Symfony используется в Laravel!!! Это ли не реклама качества кода, что даже «конкурент» пользуется твоими услугами.

Версионирование у Symfony довольно интересное. На момент моего знакомства с проектом была актуальна версия `6.3`. Чуть позже вышли версии `6.4` и `7.0`. Такой расклад оказался кстати, это позволило мне понять какую версию фреймворка выбрать.

Номер версии состоит из трёх чисел, например, `6.4.1`. Старшее число говорит о том, что в этой версии удалены все устаревшие возможности, которые присутствовали в ранней версии. Это позволяет очистить код от излишнего мусора, который когда-то был полезным, но теперь не несёт полезной нагрузки и нужен только для совместимости со старыми версиями. Увеличение второго числа говорит о том, что в коде появились новые возможности и, возможно, какой-то код устарел. При этом вы будете получать предупреждения в логах, что вы используете что-то устаревшее и это необходимо исправить до перехода на новую версию (число в первом разряде номера версии). Третье число в номере версии самое безобидное. Это просто корректирующие релизы, где ничего не менялось, но были исправлены какие-то ошибки или недоработки.

Таким образом, передо мной встал выбор между версиями `6.4.*` и `7.0.*`. С одной стороны `6.4` тянет за собой весь груз устареваний, которые в новом проекте не будут использоваться. С другой стороны минимальные требования к версии PHP у `6.4` — `PHP 8.1`, а для `7.0` — `PHP 8.2`. Если не использовать контейнеры, а пользоваться обычной виртуальной машиной на Ubuntu, то версию `PHP 8.2` до выхода Ubuntu 24.04 LTS будет затруднительно. Точнее потребуется подключать сторонние репозитории, что не очень удобно и безопасно.

Таким образом при выборе версии фреймворка лучше руководствоваться следующими принципами:

1. выбирать самую новую версию фреймворка;
2. убедиться, что эта версия способна работать на вашем сервере, т.е. поддерживает ли он необходимую версию PHP.

Как вы видите, те, кто пользуется контейнерами в плюсе. Они всегда могут использовать последнюю актуальную версию фреймворка.

С другой стороны, вы можете совершенно безболезненно перейти с версии `6.4` на `7.0`, если ваш код не выдаёт никаких предупреждений об устаревании. Однако при обновлении с версии `6.0` до `7/0` могу возникнуть проблемы. Необходимо обновиться предварительно до версии `6.4`, проверить что вашем коде устарело, исправить это и, уже потом, переходить на `7.0`.

## Создание проекта

Для старта нового проекта достаточно загрузить готовый скелет приложения c помощью composer, с нужной версией фреймворка, например:

```bash
composer create-project symfony/skeleton:"7.0.*" ИМЯ_ПРОЕКТА
```

Новый проект будет состоять из нескольких каталогов и файлов. Каталоги:

- bin — набор исполняемых файлов. Изначально есть только один `bin/console`. Через него можно выполнять запуск служебных утилит, а также собственного кода, который оформлен соответствующим образом.
- config — набор файлов конфигурации.
- public — каталог, который должен быть опубликован на вашем веб-сервер, доступный публично. Изначально там только один файл index.php, который используется для обработки запросов. Но туда можно поместить все необходимые вам файлы.
- src — папка с классами вашего приложения. Все ваши классы будут расположены в пространстве имён `App`. Это можно изменить в соответствующих с настройках в composer.json.
- var — папка со служебными файлами. Например, там располагаются файлы логов и кэш приложения. Обязательно необходимо сделать эту папку доступной для записи, иначе ваше приложение не сможет нормально работать.
- vendor — стандартный каталог с содержимым подключенных через composer к проекту пакетов.

Файлы:

- .env — файл с переменными окружения. Кроме этого файла в проекте может быть создано несколько аналогичных файлов.
- .gitignore — стандартный файл для системы контроля версий git, который указывает какие файл и каталоги не следует добавлять в репозиторий (например, vendor и var, а также другие).
- composer.json — конфигурация composer.
- composer.lock — специальный файл, который позволяет с помощью composer install полностью воспроизвести конфигурацию проекта, которая была создана на другой машине.
- symfony.lock — служебный файл Symfony.

## Файлы конфигурации

Файлы конфигурации Symfony поддерживают множество форматов. Это может быть как php код или yaml файлы, так и xml. Чаще всего используется конфигурация в формате yaml. Это довольно удобный формат для понимания человеком. Однако, в некоторых случаях удобно использовать и другие форматы, например, файлы php.

Для начала необходимо познакомиться с форматом yaml, т.к. в скелете проекта этот формат интенсивно используется.

## Мои первые проблемы с проектом

Первая проблема, с которой я столкнулся — непонятные ошибки при работе приложения. Оказалось, что для нормальной работы необходимо установить пакет для ведения логов. Это можно сделать с помощью команды:

```bash
composer require logger
```

Скрипт спросит что необходимо установить, либо будет установлен `symfony/monolog-bundle`

Я предпочитаю для хранения лога использовать journald. Для этого необходимо внести изменения в настройки логов, например, только для конфигурации dev:

```yaml config/packages/monolog.yaml
when@dev:
    monolog:
        handlers:
            main:
                type: syslog
                ident: shcc
                level: debug
                channels: ["!event"]
```

## Использование шаблонов для генерации кода

Писать код утомительно, а если вы только знакомитесь с фреймворком, то вы не знаете что писать. В этом может помочь утилита для создания шаблонного кода:

```bash
composer require --dev symfony/maker-bundle
```

Она устанавливается в `dev` секцию, т.к. на сервере необходимости в ней не будет. Она позволяет, например, создавать контроллеры, сущности и др. При создании сущностей БД, кроме самой сущности, будет создан соответствующий репозиторий. После его установки можно пользоваться командами: `bin/console make:*`.

## Использование баз данных

Установка доктрины

```bash
composer require doctrine/doctrine-bundle
```

Вопрос кодировки БД перед созданием базы!!!

Если нужен ORM. Нужен для создания Entity.

```bash
composer require doctrine/orm
```

Для создания миграций

```bash
composer require doctrine/doctrine-migrations-bundle
```

Создание миграции

```bash
bin/console make:migration
```

Запуск миграции

```bash
bin/console doctrine:migrations:migrate
```

Нужен ли?
composer require opensoft/doctrine-postgres-types

Профилировщик

composer require --dev symfony/profiler-pack

Настройка security
<https://symfony.com/doc/current/security.html>
<https://symfony.com/doc/current/security/remember_me.html>
<https://symfony.com/doc/current/session.html>

Создание контроллера

bin/console make:controller Login

composer require symfony/webpack-encore-bundle
npm install

composer require symfony/webpack-encore-bundle
npm install bootstrap --save-dev
npm install sass-loader@^13.0.0 sass --save-dev

Установка PHPUnit и Browser Kit для тестирования, второй нужен для тестирования контроллеров

```bash
composer require phpunit/phpunit --dev
composer require symfony/browser-kit --dev
```
