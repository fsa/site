---
layout: post
title: Шпаргалка по Wireguard
date: 2022-04-10 02:51:00 +0700
tags: [Git]
excerpt: Шпаргалка по настройке VPN на базе Wireguard
---
Возникла необходимость предоставить доступ из интернета устройству за NAT. Самый простой способ - заказать у провайдера выделенный IP адрес. Но это не всегда возможно. Самый простой способ - арендовать дешёвый виртуальный сервер и настроить с ним соединение через VPN. Это позволит направлять запросы из интернета на необходимый узел внутри вашей локальной сети. При этом можно предоставить статический IP адрес даже для ноутбука, который будет доступен извне по одному IP адресу, как бы он не подключился к интернету. Об этом и пойдёт речь в этой заметке.

## Что такое VPN

Пишу эти строки в мире, где VPN тождественно способу обхода блокировок в интернете. Но что из себя представляет VPN реально?

Всё очень просто. VPN - это просто виртуальный кабель между двумя машинами. Сервер - это то место, куда вы можете включить свой виртуальный кабель, клиент - это вы с кабелем. При этом, в отличие от реального мира, сервер и клиент могут быть расположены на разных концах света. Всё, что вам нужно, чтобы клиент имел возможность соединиться с сервером.

Почему VPN выступает в качестве средства обхода блокировок? Всё просто. Поскольку вы смогли пробросить виртуальный кабель до удалённой сети, вы можете пользоваться всеми её возможностями, в том числе и доступом в интернет через шлюз этой сети.

## Почему Wireguard?

Этот вопрос бы у вас не возник, если вы пробовали настроить, например, OpenVPN. Вереница параметров конфигурации клиента и сервера, создание ключей и прочее. Настройки Wireguard намного проще. Он использует современную криптографию и имеет высокую производительность.

## Установка необходимых компонентов

Для дальнейшей настройки необходим пакет `wireguard-tools`. Он доступен в репозиториях Ubuntu 20.04 LTS и Fedora 35 под этим именем. В других дистрибутивах названием может отличаться. Пакет включает в себя команды `wg` и `wg-quick`, которые нам понадобятся.

## Создание ключей

Поскольку мы создаём туннель между двумя точками, то они должны обменяться своими ключами для обмена сообщениями. Для безопасности используется асимметричное шифрование. Т.е. каждая сторона имеет свои закрытый и открытый ключ. Закрытый ключ должен сохраняться в секрете на устройстве, которое будет отправлять с помощью этого ключа данные. Открытый ключ можно опубликовать. С помощью этого открытого ключа ваш собеседник может зашифровать свои сообщения и расшифровать их можно будет только при наличии закрытого ключа. Таким образом, нужно сформировать пары публичного и закрытого ключей на стороне сервера и клиента и обменяться ими. Сервер должен знать публичный ключ клиента, клиент - публичный ключ сервера.

Сформировать пару ключей (публичный и закрытый), согласно документации, можно с помощью команды

```bash
wg genkey | tee private.key | wg pubkey > public.key
```

`wg genkey` формирует закрытый ключ, команда `tee private.key` сохраняет этот ключ в файл `private.key` и передаёт по цепочке следующей команде - `wg pubkey`, которая генерирует на базе закрытого ключа открытый ключ. Далее этот открытый ключ сохраняется в файле public.key. После генерации ключей лучше скрыть `private.key` от чужих глаз установив разрешения 600 на файл

```bash
chmod 600 private.key
```

## Настройка сервера и клиента

Настройки wireguard находятся в папке `/etc/wireguard`. В этой папке необходимо создать файл с расширением conf и именем сетевого интерфейса для соединения. Пример файла `wg0.conf` для сервера:

```ini
[Interface]
Address = 192.168.0.1/24
PrivateKey = SERVER_PRIVATE_KEY
ListenPort = 35053

[Peer]
PublicKey = CLIENT_PUBLIC_KEY
AllowedIPs = 192.168.0.2
```

В данной конфигурации создаётся виртуальная сеть с адресацией `192.168.0.0/24`, адрес сервера в этой сети `192.168.0.1`. Параметр `ListenPort` указывает на то, что это сервер и он будет прослушивать порт 35053 на сетевых интерфейсах для входящих подключений.

Секция `[Peer]` описывает клиента и может быть использована несколько раз для разных клиентов. В секции указан публичных ключ клиента и его адрес в виртуальной сети.

Пример файла конфигурации `wg0-client.conf` для клиента:

```ini
[Interface]
Address = 192.168.0.2
PrivateKey = CLIENT_PRIVATE_KEY

[Peer]
PublicKey = SERVER_PUBLIC_KEY
AllowedIPs = 192.168.0.0/24
Endpoint = SERVER_NAME:35053
PersistentKeepalive = 20
```

Клиентская конфигурация незначительно отличается от серверной. В секции `[Interface]` указан IP адрес клиента в виртуальной сети и закрытый ключ клиента. Секция `[Peer]` содержит публичный ключ сервера, диапазоны сетей, которые должны быть доступны через соединение. `Endpoint` указывает на адрес и порт сервера. Параметр `PersistentKeepalive` позволит автоматически восстанавливать соединение.

## Проверяем подключение

Протестировать соединение можно с помощью утилиты `wg-quick`, например:

```console
# wg-quick up wg0-client
[#] ip link add wg0-client type wireguard
[#] wg setconf wg0-client /dev/fd/63
[#] ip -4 address add 192.168.0.2 dev wg0-client
[#] ip link set mtu 1420 up dev wg0-client
[#] ip -4 route add 192.168.0.0/24 dev wg0-client
```

Если всё было настроено правильно, будет добавлен сетевой интерфейс wg0-client и ему будет присвоен IP адрес.

Обеспечить автоматический запуск сервера и/или клиента можно с помощью команды:

```bash
systemctl enable --now wg-quick@wg0
```

При этом wg0 - это имя соединения: wg0 - сервер, wg0-client - клиент. Ключ `--now` позволит сразу запустит службу после её активации.

## Заключение

В результате настройки клиента и сервера мы получили виртуальную сеть между двумя узлами. С помощью этого соединения можно получить доступ к ресурсам, которые ранее были недоступны. При этом при обмене через VPN можно использовать даже нешифрованные соединения, поскольку весь трафик VPN скрыт от любопытных глаз шифрованием.