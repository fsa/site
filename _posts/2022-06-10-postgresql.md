---
layout: post
title: PostgreSQL
date: 2022-06-08 23:57:00 +0700
tags: [postgresql]
excerpt: Шпаргалка по PostgreSQL
published: false
---

## Инициализация базы данных

При инициализации базы данных следует обратить внимание на два параметра:

* LC_COLLATE - отвечает за то, как будут сортироваться символы при выполнении сортировки;
* LC_CTYPE - отвечает за категории типов символов, например, чтобы одинаковые слова на кириллице считались одинаковыми независимо от регистра символов в них.

После создания кластера БД эти параметры невозможно будет изменить.

{% comment %}
    Выбор locale.
{% endcomment %}

## Настройка сервера

В большинстве операционных систем при установке сервера из репозиториев создаётся пользователь postgres (а ранних версиях FreeBSD - pgsql). При настройках по умолчанию PostgreSQL сервер использует текущего пользователя для проверки доступа к серверу. Поэтому для подключения к серверу необходимо переключиться на пользователя postgres. Далее можно воспользоваться утилитами для командной строки (`createuser`, `createdb`, `dropuser`, `dropdb` и др.) или запустить интерактивный терминал psql.

Для запуска psql пользователем root:

```bash
su - postgres
psql
```

Для пользователя, обладающего достаточными правами sudo:

```bash
sudo -u postgres psql
```

либо

```bash
sudo -u postgres -i
psql
```

Просле успешного запуска клиента будет отображена его версия и приглашение для ввода команд. В приглашении указывается имя текущей базы данных.

```console
psql (14.3 (Ubuntu 14.3-0ubuntu0.22.04.1))
Type "help" for help.

postgres=#
```

Подробнее ознакомиться с возможностями оболочки можно с использованием команд `\h` и `\?`.

### Просмотр доступных баз данных

```console
postgres=# \l
                                  List of databases
   Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges
-----------+----------+----------+-------------+-------------+-----------------------
 postgres  | postgres | UTF8     | ru_RU.UTF-8 | ru_RU.UTF-8 |
 template0 | postgres | UTF8     | ru_RU.UTF-8 | ru_RU.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
 template1 | postgres | UTF8     | ru_RU.UTF-8 | ru_RU.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
(3 rows)
```

Изначально в кластере создаётся 3 базы данных:

1. `template0` - Первоначальный шаблон для новых баз данных. Не должен изменяться ни при каких обстоятельствах!!!
2. `template1` - Шаблон базы данных. Применяется по умолчанию при создании новой базы данных, если не указан другой шаблон. Может быть изменён.
3. `postgres` - Служебная база данных по умолчанию для пользователя postgres. При подключении пользователя к серверу, например, при помощи psql, происходит выбор базы данных с именем текущего пользователя, если не указан другой. При отсутствии базы данных будет происходить ошибка подключения. Эта база позволяет пользователя postgres успешно подключиться даже если база данных не была указана.

В примере все базы данных имеют Collate и Ctype равным ru_RU.UTF-8. На ОС Ubuntu это значение при инициализации берётся из настроек текущего пользователя.

### Создание пользователя

Для создания новых пользователей используется команда `CREATE USER` или `CREATE ROLE`. Все доступные опции команд описаны [в документации][create-role]. `CREATE USER` является синонимом для `CREATE ROLE`, но имеет по умолчанию выключенной опцию `LOGIN`.

## Бекап базы данных и её восстановление

Для создания дампов и их восстановления отдельных БД в PostgreSQL имеются утилиты [pg_dump][pg_dump] и [pg_restore][pg_restore]. Кроме этого, сделать дамп всего кластера БД можно с помощью утилиты pg_dumpall, которая использует при своей работе pg_dump, и восстановить с помощью утилиты psql.

Наиболее полезные ключи при создании дампа базы данных

```bash
pg_dump -h hostname -U username -F format -f dumpname dbname
```

* hostname - адрес сервер БД;
* username - имя пользователя БД;
* format - формат дампа:
  * p (по умолчанию) - текстовый SQL-скрипт;
  * c - архивный формат для утилиты pg_restore;
  * d - выгрузить данные в формате каталога, также применяется сжатие;
  * t - формат tar - архив tar, который распаковывается в каталог, аналогичный предыдущему формату;
* dumpname - имя файла данных или каталога;
* dbname - имя базы данных.

Восстановление базы из дампа:

```bash
pg_restore -h hostname -U username -F format -d dbname dumpname
```

Параметры аналогичные, за исключением format, который при восстановлении может быть только `c`, `d` или `t`.

Для восстановленя дампа из SQL-скрипта можно использовать команду psql.

Пример создания дампа и восстановления из него

```bash
pg_dump -Fc -f db_name.dump db_name
pg_restore -Fc -d db_name db_name.dump
```

1. [Перевод официальной документации по pg_dump](pg_dump)
2. [Перевод официальной документации по pg_restore](pg_restore)
3. [Перевод официальной документации по CREATE USER](create-role)

[pg-dump]: https://postgrespro.ru/docs/postgresql/14/app-pgdump
[pg-restore]: https://postgrespro.ru/docs/postgresql/14/app-pgrestore
[create-role]: https://postgrespro.ru/docs/postgresql/14/sql-createrole
