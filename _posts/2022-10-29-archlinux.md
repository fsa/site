---
layout: post
title: Установка Archlinux
date: 2022-10-29 02:01:00 +0700
tags: [Archlinux, btrfs, EFI]
excerpt: Ради интереса решил поставить Archlinux на btrfs на компьютер у EFI
---

Давно смотрю в сторону Archlinux. Даже пробовал использовать его вместо Ubuntu. Но что-то пошло не так, и я перешёл на Gentoo. В Gentoo тоже что-то пошло не так, но я разобрался и правильно поставил драйвер на видеокарту. Однако решил уже не возвращаться в Archlinux. Спустя много лет решил попробовать хотя бы установить систему на виртуальную машину.

При привычке решил воспользоваться [мануалом на сайте проекта](https://wiki.archlinux.org/title/Installation_guide_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)). Всегда так делал в Gentoo. Однако во время установки возникли некоторые проблемы, поэтому решил записать процесс установки.

Установка начинается с разметки диска. Для этого существует масса утилит, которые перечислены в мануале. Я выбрал cgdisk:

```bash
cgdisk /dev/sda
```

После запуска на диске необходимо создать разделы, как минимум:

1. EFI раздел: тип EF00;
2. root раздел: тип 8300 (по умолчанию).

Первый нужен для успешной загрузки через EFI. Во втором будут размещены наши данные. Я решил выбрать файловую систему btrfs, поскольку использую её уже много лет.

Форматируем разделы:

```bash
mkfs.fat -F 32 /dev/sda1
mkfs.btrfs /dev/sda2
```

На настоящих системах может понадобиться раздел подкачки. Но и без него можно обходиться.

Для удобства создадим подтома на btrfs: root и home. Раздел root будет корнем нашей файловой системы, home будет хранить домашние папки пользоватей (`/home`).

```bash
mount /dev/sda2 /mnt
btrfs subvolume create /mnt/root
btrfs subvolume create /mnt/home
```

После создания подтомов отключим том и подключим вне необходимые для установки разделы создавая при этом необходимые точки монтирования (опция `--mkdir` команды `mount`):

```bash
umount /dev/sda2
mount -o subvol=/root /dev/sda2 /mnt
mount --mkdir -o subvol=/home /dev/sda2 /mnt/home
mount --mkdir /dev/sda1 /mnt/boot
```

Далее необходимо смонтировать swap. Но, поскольку я ставлю просто из интереса, создавать я его не буду. К тому же можно на системах с большим количеством оперативной памяти использовать zram или аналогичные механизмы, а также создавать файлы подкачки.

В соответствии с инструкцией по установке установим базовые пакеты

```bash
pacstrap -K /mnt base linux linux-firmware
```

Сгенерируем файл /etc/fstab имеющимися в наличии утилитами:

```bash
genfstab -U /mnt >> /mnt/etc/fstab
```

После этого можно перейти в chroot окружение уже установленной системы:

```bash
arch-chroot /mnt
```

Дальше следуем инструкциям из официального муануала касательно часов и заменяем /etc/localtime на символическую ссылку на файл с нужным часовым поясом:

```bash
ln -sf /usr/share/zoneinfo/Регион/Город /etc/localtime
hwclock --systohc
```

Следующим шагом идёт настройка локалей. Однако в нашей системе всё ещё отсутствуют редакторы, поэтому необходимо установить удобный для вас, например, nano или vim, или вообще установить полноценный файловый менеджер mc (Midnight Commander). Установим vim:

```bash
pacman -S vim
```

Редактируем файл `locale.gen` путём удаления комментариев перед `ru_RU.UTF-8`:

```bash
vim /etc/locale.gen
```

Далее вновь следуем инструкциям с официального сайта проекста:

```
locale-gen
echo LANG=ru_RU.UTF-8 > /etc/locale.conf
```

Установим имя хоста (для примера, archlinux)

```bash
echo archlinux > /etc/hostname
```

Установим `grub` и `efibootmgr`, который нужен для установки grub на системах с EFI:

```bash
pacman -S grub efibootmgr
```

Установим Grub и создадим для него конфигурацию:

```bash
grub-install --efi-directory=/boot
grub-mkconfig -o /boot/grub/grub.cfg
```

Теперь необходимо задать пароль для пользователя root или, лучше, создать своего пользователя и разрешить ему запуск процессов через sudo.

Если вы решили задать пользователю root пароль, то просто выполните

```bash
passwd
```

После этого можно перезагрузить машину. Но это не самый лучший, с точки зрения безопасности, вариант.

Создадим нового пользователя, при этом, добавим его в группу wheel и создадим домашнюю папку по умолчанию, а также создадим пароль:

```bash
useradd my_user -G wheel -m
passwd my_user
```

Установим пакет sudo и разрешим группе wheel его использовать создав файл g_wheel (можно также исправить /etc/sudoers):

```bash
pacman -S sudo
echo "%wheel ALL=(ALL) ALL" > /etc/sudoers.d/g_wheel
```

В качестве сервиса работы с сетью используем networkd из состава systemd (вы можете использовать NetworkManager, netplan.io и другие, по желанию). Чтобы интерфейс с именем `enp0s3` получил автоматические настройки через DHCPD, создадим файл `/etc/systemd/networkd/enp0s3.network` со следующим содержанием:

```ini
[Match]
Name=enp0s3

[Network]
DHCP=yes
```

Активируем сервисы и позволим systemd контролировать адреса используемых DNS серверов заменив /etc/resolv.conf на символическую ссылку:

```bash
systemctl enable systemd-networkd
systemctl enable systemd-resolved
ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf
```

На этом можно завершить установку системы, выйти из chroot и перезапустить машину:

```bash
exit
reboot
```

После перезагрузки вы должны попасть в командную строку вашей свежеустановленной системы. У меня с первого раза это не получилось. При этом я не мог попасть в меню загрузки Vitrualbox. Решил это путём удаления HDD из настроек виртуальной машины, а уже после запуска с CD подключил его обратно. Дальше монтируем файловую систему и переходим в chroot и исправляем свои ошибки.

Пока на этом всё. Я получил работающий Archlinux внутри своей виртуальной машины.
