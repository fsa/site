---
layout: post
title: Установка Archlinux
date: 2022-10-29 02:01:00 +0700
tags: [Archlinux, btrfs, EFI]
excerpt: Ради интереса решил поставить Archlinux на btrfs на компьютер у EFI
---

Давно смотрю в сторону Archlinux. Даже пробовал использовать его вместо Ubuntu. Но что-то пошло не так, и я перешёл на Gentoo. В Gentoo тоже что-то пошло не так, но я разобрался и правильно поставил драйвер на видеокарту. Однако решил уже не возвращаться в Archlinux. Спустя много лет решил попробовать хотя бы установить систему на виртуальную машину.

При привычке решил воспользоваться [мануалом на сайте проекта](https://wiki.archlinux.org/title/Installation_guide_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)). Всегда так делал в Gentoo. Однако во время установки возникли некоторые проблемы, поэтому решил записать процесс установки.

Установка начинается с разметки диска. Для этого существует масса утилит, которые перечислены в мануале. Я выбрал cgdisk:

```bash
cgdisk /dev/sda
```

После запуска на диске необходимо создать разделы, как минимум:

1. EFI раздел: тип EF00;
2. root раздел: тип 8300 (по умолчанию).

Первый нужен для успешной загрузки через EFI. Во втором будут размещены наши данные. Я решил выбрать файловую систему btrfs, поскольку использую её уже много лет.

Форматируем разделы:

```bash
mkfs.fat -F 32 /dev/sda1
mkfs.btrfs /dev/sda2
```

На настоящих системах может понадобиться раздел подкачки. Но и без него можно обходиться.

Для удобства создадим подтома на btrfs: root и home. Раздел root будет корнем нашей файловой системы, home будет хранить домашние папки пользоватей (`/home`).

```bash
mount /dev/sda2 /mnt
btrfs subvolume create /mnt/root
btrfs subvolume create /mnt/home
```

После создания подтомов отключим том и подключим вне необходимые для установки разделы создавая при этом необходимые точки монтирования (опция `--mkdir` команды `mount`):

```bash
umount /dev/sda2
mount -o subvol=/root /dev/sda2 /mnt
mount --mkdir -o subvol=/home /dev/sda2 /mnt/home
mount --mkdir /dev/sda1 /mnt/boot
```

Далее необходимо смонтировать swap. Но, поскольку я ставлю просто из интереса, создавать я его не буду. К тому же можно на системах с большим количеством оперативной памяти использовать zram или аналогичные механизмы, а также создавать файлы подкачки.

В соответствии с инструкцией по установке установим базовые пакеты

```bash
pacstrap -K /mnt base linux linux-firmware
```

Сгенерируем файл /etc/fstab имеющимися в наличии утилитами:

```bash
genfstab -U /mnt >> /mnt/etc/fstab
```

После этого можно перейти в chroot окружение уже установленной системы:

```bash
arch-chroot /mnt
```

Дальше следуем инструкциям из официального муануала касательно часов:

```bash
ln -sf /usr/share/zoneinfo/Регион/Город /etc/localtime
hwclock --systohc
```

Следующим шагом идёт настройка локалей. Однако в нашей системе всё ещё отсутствуют редакторы, поэтому необходимо установить удобный для вас, например, nano или vim, или вообще установить полноценный файловый менеджер mc (Midnight Commander). Установим vim:

```bash
pacman -S vim
```

Редактируем файл `locale.gen` путём удаления комментариев перед `ru_RU.UTF-8`:

```bash
vim /etc/locale.gen
```

Далее вновь следуем инструкциям с официального сайта проекста:

```
locale-gen
echo LANG=ru_RU.UTF-8 > /etc/locale.conf
```

Установим имя хоста (для примера, archlinux)

```bash
echo archlinux > /etc/hostname
```

Установим `grub` и `efibootmgr`, который нужен для установки grub на системах с EFI:

```bash
pacman -S grub efibootmgr
```

Установим Grub и создадим для него конфигурацию:

```bash
grub-install --efi-directory=/boot
grub-mkconfig -o /boot/grub/grub.cfg
```

На этом можно завершить установку системы, выйти из chroot и перезапустить машину:

```bash
exit
reboot
```

После перезагрузки вы должны попасть в командную строку вашей свежеустановленной системы. У меня с первого раза это не получилось. При этом я не мог попасть в меню загрузки Vitrualbox. Решил это путём удаления HDD из настроек вирутальной машины, а уже после запуска с CD подключил его обратно.

Пока на этом всё. Я получил работающий Archlinux внутри своей виртуальной машины.
