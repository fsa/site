---
layout: post
title: Эксперимент с только IPv6 на ПК
date: 2022-12-01 01:00:00 +0700
tags: [IPv6, NAT64, Bind, DNS, TAYGA, radvd]
excerpt: Решил провести эксперимент как будет вести себя Linux в сети с только IPv6 протоколом. В качестве шлюза также использовал Linux.
---
## Это черновик

Решил провести эксперимент как будет вести себя Ubuntu Linux в сети с только IPv6 протоколом. В качестве шлюза также использовал Ubuntu Linux. Сеть из этих двух машин создал в VirtualBox. При этом первая машина имеет два сетевых интерфейса, один из которых подключен к моей локальной сети, а второй к внутренней сети VirtualBox. Вторая машина подключена только ко внутренней сети.

## В чём суть проблемы?

Во время перехода интернета с IPv4 на IPv6 необходимо как-то обеспечить работу сети с учётом сервисов, которые работают только по IPv4. Можно использовать дуалстэк, т.к. использовать внутри сети IPv4 и IPv6 адресации. При этом для IPv4, скорее всего, будет использован NAT. Схема хоть и рабочая, но в больших сетях заставит дополнительно трудиться и настраивать два протокола вместо одного.

Суть второго метода - использовать в сети адресацию только IPv6. Для доступа к ресурсам IPv4 применяется трансляция NAT64 на одном из узлов, который имеет IPv4 адрес. Схема работы примерно как в первом случае, всё равно используется NAT, но при этом нет необходимости в настройке IPv4.

Как же заставить приложения обратиться к нашему узлу трансляции? Самое простое - манипуляция с DNS запросами. В случае, если при получении адреса через DNS не возвращаются записи типа `AAAA`, а только записи `A`, то DNS должен создать «недостающие» записи, которые и направят запрос на сервер трансляции NAT64.

Ограничения подобной схемы:

1. При обращении по IPv4 адресу непосредственно, возникнет ошибка, т.к. протокол IPv4 не поддерживается хостом.
2. Если домен использует DNSSEC и не имеет записей `AAAA`, то наши «фейковые» `AAAA` записи не будут иметь корректной цифровой подписи. По имеющейся у меня информации это не сильно критично, потому что узлов с DNSSEC и без записей `AAAA` (тех, для которых потребуется трансляция) крайне мало.

## Какой софт понадобится?

- [radvd](https://radvd.litech.org/) - демон обеспечения анонсов маршрутизатора;
- [Bind 9](https://www.isc.org/bind/) - DNS сервер с функцией DNS64;
- [TAYGA](http://www.litech.org/tayga/) - транслятор NAT64.

## Подготовка к установке

Первое, что необходимо сделать, определиться с адресацией IPv6, которая будет использована для для механизма трансляции. Этот префикс необходимы выбирать исходя из адресации вашей сети. В качестве диапазона может быть использован глобально уникальный диапазон адресов или локально уникальный. Однако если вы планируете получать доступ к локальной адресации IPv4 (RFC 1918), то необходимо использовать специально выделенный диапазон `64:ff9b::/96` (RFC 6052). Глобально уникальный диапазон адресов позволит пользоваться вашим сервисом даже за пределами вашей сети. Остальное доступно только в пределах локальной сети при настройке соответствующей маршрутизации.

В дальнейшем я буду использовать диапазон `64:ff9b::/96`.

## Настройка Bind 9

Настройку можно начать с DNS. Bind 9 начиная с версии 9.8 позволяет использовать специальную опцию `dns64`, которую необходимо разместить в секции `options`:

```text
options {
...
    dns64 64:ff9b::/96 {
        suffix ::;
        clients { any; };
        mapped { any; };
    };
};
```

Перезапускаем службу `named`. Теперь ответ от DNS сервера должен запись `AAAA`, которая указывает на адрес из выбранного диапазона. Проверим любой адрес, который не имеет записей `AAAA` в DNS, например, `habr.com`:

```console
# nslookup
> habr.com
Server:  127.0.0.53
Address: 127.0.0.53#53

Non-authoritative answer:
Name: habr.com
Address: 178.248.237.68
Name: habr.com
Address: 64:ff9b::b2f8:ed44
>
```

При этом, если мы запрашиваем адрес, который уже имеет записи `AAAA`, то ответ не модифицируется:

```console
> tavda.info
Server:  127.0.0.53
Address: 127.0.0.53#53

Non-authoritative answer:
Name: tavda.info
Address: 89.208.105.251
Name: tavda.info
Address: 2a0e:d602:1:f8::a
```

## Настройка radvd

```text
interface enp0s8
{
    AdvSendAdvert on;
    MinRtrAdvInterval 30;
    MaxRtrAdvInterval 100;
    prefix 2a06:a004:d0cf:1::/64
    {
        AdvOnLink on;
        AdvAutonomous on;
        AdvRouterAddr off;
    };
    RDNSS 2a06:a004:d0cf::2 {
    };
};
```

## Настройка TAYGA

```text
tun-device nat64

ipv4-addr 10.0.2.129

## Для 64:ff9b::/96
ipv6-addr 2a06:a004:d0cf::3

#prefix 2001:db8:1:ffff::/96
prefix 64:ff9b::/96
#prefix 2a06:a004:d0cf:ffff::/96

dynamic-pool 10.0.2.128/25
data-dir /var/spool/tayga
```


```ini
net.ipv6.conf.default.forwarding = 1
net.ipv6.conf.all.forwarding = 1
net.ipv4.ip_forward = 1
```
