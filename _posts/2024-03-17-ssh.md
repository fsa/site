---
layout: post
title: SSH
date: 2024-03-17 05:14:00 +0700
tags: [SSH, Linux]
excerpt: Небольшая заметка о том, как настраивать и использовать SSH.
---

В данной заметке рассматривается использование клиента и сервера SSH на базе Linux, однако заметка может быть полезна и для пользователей других операционных систем. Не исключено, что позже тут появятся дополнения по использованию Putty или других программ в ОС Windows.

Как гласит википедия, «SSH — сетевой протокол прикладного уровня, позволяющий производить удалённое управление операционной системой и туннелирование TCP-соединений (например, для передачи файлов). Схож по функциональности с протоколами Telnet и rlogin, но, в отличие от них, шифрует весь трафик, включая и передаваемые пароли. SSH допускает выбор различных алгоритмов шифрования. SSH-клиенты и SSH-серверы доступны для большинства сетевых операционных систем». Когда ты первый раз знакомишься с ним, то, скорее всего, для тебя он представляется как средство для доступа к удалённому серверу. В первую очередь, так оно и есть. Однако его возможности намного шире.

Что может протокол SSH:

- заменить telnet — обеспечить доступ к терминалу удалённой машины по шифрованному каналу;
- заменить ftp — обеспечить обмен файлами с удалённой машиной по шифрованному каналу и без необходимости обходить ограничения, которые присущи ftp при работе через NAT и прокси;
- обеспечить проброс портов — обеспечить доступ к портам с локальной машины или её сети на порты, которые доступы удалённой машине;
- socks-прокси — обеспечить локальное устройство или целую сеть socks-прокси через удалённую машину;
- выполнение команд на удалённой машине из скриптов локальной машины.

Самое главное, что SSH обеспечивает безопасность соединения с удалённой машиной с помощью современных алгоритмов шифрования. Вся пересылаемая информация между узлами находится внутри зашифрованного туннеля.

## Как работает SSH

SSH, как не трудно догадаться, работает аналогично telnet, в режиме точка-многоточка. В этом режиме есть некоторый узел, к которому могут подключаться другие узлы — сервер. Все клиенты подключаются к этому серверу.

В Linux системах сервер обозначается `sshd`, что означает SSH демон (Daemon). Клиент SSH — `ssh`. Все необходимые настройки для клиента и сервера, в Linux системах, обычно хранятся в папке `/etc/ssh`. По префиксу имени файла можно догадаться к клиенту или серверу имеет отношение файл настройки. Все настройки имеют глобальный характер, т.е. актуальны для всех пользователей устройства.

Кроме глобальных настроек, каждый из пользователь может хранить свою конфигурацию в домашней директории в папке `~/.ssh`. Что можно найти в этой директории, рассмотрим далее.

Файл `config` — файл настройки клиента. Позволяет настраивать параметры соединений, чтобы не было необходимости каждый раз указывать опции для каждого конкретного сервера.

Файл `authorized_keys` содержит список ключей для доступа к этому пользователю через сервер `sshd` на этой машине. Обычно этот файл отсутствует, но если вы хотите использовать при подключении к данной машине под данным пользователем не только имя пользователя и пароль, но и ключ, то этот файл должен быть создан.

Файл `known_hosts` содержит список ключей для хостов, к которым ранее уже было произведено подключение. Это один из инструментов безопасности. При первом подключении к серверу вы получаете подпись его ключа доступа, которую в дальнейшем будете использовать для проверки легитимности хоста. При повторном подключении эти данные позволяют проверить, что это именно тот сервер, к которому вы подключались. Если вы при подключении к серверу получаете ошибку, возможно в ваш сеанс подключения желает кто-то вклиниться с целью дешифровки передаваемых данных. Если вы не перестраивали сервер, то это будет для вас знаком, что доверять серверу нельзя.

Файлы `id_*` содержат закрытые ключи доступа для текущего устройства. Вместо `*` в имени файла присутствует имя используемого алгоритма шифрования. Ключей может быть несколько для каждого запрошенного алгоритма шифрования. Эти файлы должны храниться в полной секретности. Никому их передавать нельзя. На ключи доступа можно установить пароль, без которого невозможно будет воспользоваться этим ключом. В таком случае даже в случае утечки ключа воспользоваться им будет невозможно без знания пароля.

Файлы `id_*.pub` содержат публичные ключи доступа, которые используются для подключения к другим устройствам. Вместо `*` в имени файла присутствует имя используемого алгоритма шифрования, которые предоставляет удалённое устройство при подключении. Ключей может быть несколько для каждого доступного алгоритма шифрования.

Кроме этого, имена публичных ключей шифрования могут быть любыми. В этом случае при подключении нужно прямо указать какой файл вы будете использовать при подключении к удалённой машине. Эти файлы также можно хранить в этой папке.

Для того, чтобы подключиться к нужной машине просто запустите команды `ssh` с указанием имени хоста и, при необходимости, имени пользователя. Если пользователь не указан, то будет использовано имя текущего пользователя в системе.

```bash
ssh user@host
```

После этого, при успешном подключении, вам будет предложено ввести пароль пользователя. После подтверждения корректности пароля вы сможете управлять удалённой машиной.

## Использование ключей

Самый простой способ аутентификации при соединении — использование пароля. Однако есть более безопасный способ — использование ключей. Для того, чтобы сформировать свой ключ можно воспользоваться утилитой `ssh-keygen`. По умолчанию она создаёт ключи rsa. Сейчас рекомендуется использовать ключи формата ed25519. Они более компактные и обеспечивают достаточный уровень защищённости. Создайте пару ключей с помощью команды

```bash
ssh-keygen -t ed25519
```

Во время создания ключа будет уточнено куда сохранять пару ключей и какой пароль использовать для доступа к ключу. Можно не указывать пароль, но в таком случае, в случе утечки вашего закрытого ключа злоумышленники легко смогут им воспользоваться. Конечно, вводить пароль при каждом использовании ключа неудобно и есть соблазн не использовать пароль. Но эту проблему легко решить, о чём будет рассказано далее.

```console
Generating public/private ed25519 key pair.
Enter file in which to save the key (/home/user/.ssh/id_ed25519):       
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /home/user/.ssh/id_ed25519
Your public key has been saved in /home/user/.ssh/id_ed25519.pub
The key fingerprint is:
SHA256:Q8iNlV3kFMGi40OrqOLIn/PPHWKuj/ccom6hs8U1coA user@alpha
The key's randomart image is:
+--[ED25519 256]--+
|        .o +*o   |
|    .. =. oo.    |
|   E .+ o. ..    |
|      ..+        |
|     . *So       |
|    ..+ =.       |
|    .+.= +       |
|+  ++.B.= o      |
|o+o=B*==.+       |
+----[SHA256]-----+
```

После этих действий будет создано два файла: один с приватным ключом, другой с открытым (имя файла имеет расширение `.pub`). Теперь чтобы использовать ключ при подключении к удалённым машинам необходимо скопировать открытый ключ на нужный узел. После этого вы сможете подключаться на него используя ваш приватный ключ. Скопировать ключ можно просто копируя содержимое файла `id*.pub` в файл `authorized_keys` в папке нужного вам пользователя на удалённой машиной. Кроме этого свой публичный ключ можно скопировать с помощью команды

```bash
ssh-copy-id user@host
```

Если вы имеете несколько пар ключей, то вы можете указать какой конкретно ключ необходимо использовать:

```bash
ssh-copy-id -i .ssh/id_ed25519 user@host
```

После запуска команды она попытается загрузить ключ на удалённую машину. Естественно, у вас должен быть туда доступ, например с помощью пароля. Если ваш ключ был успешно загружен, то теперь вы можете его использовать при новых подключениях.

## Диагностика ошибок подключения

Если есть проблема с подключением, можно активировать вывод диагностических сообщений:

```bash
ssh -v gitea@gitea.example
```

Это позволит подробнее изучить то, что происходит при подключении и выявить проблему.

## Файл конфигурации .ssh/config

Файл конфигурации ssh клиента представляет из себя текстовый файл, где перечисляются настройки для различных хостов. Директива `Host` указывает, что далее идут настройки для определённого хоста или нескольких хостов. Далее можно указать какое имя хоста использовать для подключения, какой порт использовать, какой файл ключа, а также, например, использовать только аутентификацию по ключу:

```console
Host my_server
Hostname fd12::8
Port 8022
IdentityFile ~/.ssh/id_ed25519
IdentitiesOnly yes
```

В данном случае при выполнении команды `ssh my_server` с такими настройками будет произведено подключение к хосту по протоколу IPv6 на адрес `[fd14::8]` и порт 8022. Будет использован ключ `~/.ssh/id_ed25519`. Идентификация по паролю не будет использована.

Можно сделать аналогичные настройки для всех необходимых для вас хостов.

Файл конфигурации лучше скрыть от глаз других пользователей машины установив права доступа `600` и убедиться, что файл принадлежит вашему пользователю:

```bash
chmod 600 ~/.ssh/config
chown $USER ~/.ssh/config
```

Подробнее о файле конфигурации можно получить из `man ssh_config`.

## ssh-agent

Как уже было сказано ранее, свой публичный ключ лучше защитить паролем, потому что в случае его утечки было сложно им воспользоваться. Но при этом при каждом новом подключении по ssh необходимо вводить пароль. Решить эту проблему может ssh-agent. Это сервис, который хранит ваши ключи в расшифрованном виде после первого использования. При первом использовании ключа необходимо будет ввести пароль, после чего сервис запомнит ключ и будет в дальнейшем использовать его не требуя от вас пароля.

Чтобы воспользоваться этим сервисом необходимо его предварительно запустить. Сделать это можно автоматически при каждом входе в систему, например, с помощью systemd юнита. Для этого создайте файл `~/.config/systemd/user/ssh-agent.service` со следующим содержимым:

```systemd
[Unit]
Description=SSH key agent

[Service]
Type=simple
Environment=SSH_AUTH_SOCK=%t/ssh-agent.socket
ExecStart=/usr/bin/ssh-agent -D -a $SSH_AUTH_SOCK

[Install]
WantedBy=default.target
```

Далее необходимо создать или добавить в файл `~/.config/environment.d/ssh_auth_socket.conf`:

```console
SSH_AUTH_SOCK="${XDG_RUNTIME_DIR}/ssh-agent.socket"
```

После этого можно активировать сервис и запустить его:

```bash
systemctl --user enable --now ssh-agent
```

Теперь можно вручную добавлять необходимые ключи с помощью `ssh-add`. Однако это не очень удобно. Чтобы ключи автоматически добавлялись в агент необходимо в файле настройки клиента `~/.ssh/config` добавить следующую строчку:

```console
AddKeysToAgent yes
```

После этого любой используемый ключ будет автоматически добавлен в агента.

Кроме этого агент умеет пробрасывать ключ на удалённые машины, если там необходимо соединиться с другими машинами. Разрешить это можно с помощью добавления `ForwardAgent yes` в файле настроек `~/.ssh/config`:

```console
Host my_server
ForwardAgent yes
```
