---
layout: post
title: О переходе на IPv6
date: 2025-02-28 04:29:10 +0700
tags: [IPv6]
excerpt: Заметка о том, какие методы можно использовать при переходе от IPv4 к IPv6 и можно ли полностью отказаться от IPv4 уже сейчас.
published: true
--- 

Зачем, собственно, переходить на новый протокол? Бурный рост сети интернет в 1990-е годы привёл к значительному расходованию доступных IP адресов. Стало очевидно, что тенденция увеличения количества устройств приведёт к тому, что адресное пространство IP просто исчерпается.

Подробнее о том, почему протокол так отличается от старой версии я уже писал ранее в заметке «[Знакомство с IPv6 на практике](https://habr.com/ru/articles/773708/)». Если кратко, то расширение адресного пространства требует обновления программного обеспечения на всём парке устройств, а значит нет необходимости тянуть за собой все недостатки старого протокола, которые были выявлены в хоте его эксплуатации.

Новая версия протокола IP может предоставить всё тоже самое, что предоставляла старая версия IP. При этом у новой версии нет недостатка в количестве адресов, а также имеется значительный запас адресного пространства.

Так в чём же проблема? На самом деле если бы произошло чудо и всё сетевое оборудование вдруг лишилось IPv4 и обзавелось поддержкой IPv6, то пользователи вряд ли бы что-то заметили. Программного обеспечения жёстко завязанного на IPv4 не так много. Увы, чудес не бывает, поэтому некоторое время придётся жить в мире где есть две версии протокола.

## Избавляемся от IPv4

А что если полностью избавиться от протокола IPv4 у себя в сети? Конечно, в большинстве случаев, большого практического смысла в этом нет и проще обеспечить работу обоих протоколов. Но давайте сделаем это и посмотрим что получится, а также попробуем решить те проблемы, которые возникли.

Выключаем IPv4 и пробуем выйти в интернет. Конечно, не забываем о том, что DNS серверы нам тоже нужны доступные по IPv6. Благо такие есть бесплатные у Google, Cloudflare и многих других. Что же у нас доступно по IPv6? Youtube, Яндекс, Facebook, Instagram, BBC и др. Вроде бы ничего не изменилось. Всё работает как и раньше.

Запускаем торрент клиент и идём на любимый трекер. Пробуем загрузить что-нибудь. И тут видим первую проблему. Большая часть раздач не грузятся. Некоторые раздачи идут, но медленно, некоторые работают без проблем. А виной всему то, что мы потеряли доступ к основной части пиров, которые работают только с IPv4 протоколом.

Мессенджеры тоже могут вести себя странно. Некоторые могут работать нормально, некоторые не работать. Опят таки дело тут в отсутствии поддержки IPv6 со стороны сервера. При этом даже если мессенджер работает, то аудио и видеозвонки могут не проходить. Как и с торрентами, проблема может быть в том, что соединение происходит по IPv4 адресу.

Как насчёт того, что может понадобиться в РФ? Зайдём на сайты: Госуслуги, Сбербанк, ВТБ, ВКонтакте, Ростелеком... Увы, но сайты недоступны. Это совсем не то, что нам надо. Можно ли эту проблему как-то решить? Можно.

## NAT64 или получаем доступ к узлам с IPv4

Первое, что мы можем сделать - каким-то образом обеспечить связь с узлами, которые используют только IPv4 адреса. Что необходимо, чтобы отправить пакет узлу с IPv4 адресом? Нам тоже нужен IPv4 адрес. Поскольку от адресации IPv4 внутри сети мы избавились, то нам нужен будет какой-то промежуточный узел, который сможет взаимодействовать по IPv6 с нашей сеть и по IPv4 с нужным нам узлом. Ничего не напоминает? Да это же всем известный NAT, который используется в IPv4 повсеместно, в том числе на вашем домашнем маршрутизаторе. Но есть небольшая разница. Если в нашем случае нам нужно преобразовывать IPv6 в IPv4 и обратно, то ранее было преобразование IPv4 в другой IPv4 и обратно. Таким образом, чтобы не путать эти типы NAT, обозначим старый как NAT44, а наш новый тип NAT64, в соответствии с версиями IP на нашей и удалённой стороне.

Всё новое - это хорошо забытое старое. Теперь в нашей сети появился специальный шлюз, который выполняет преобразование из IPv6 в IPv4 - NAT64. Теперь любой узел нашей сети может отправить запрос на шлюз и через него получить ответ от узла IPv4. Например, пусть наш шлюз имеет адресацию 2001:db8::/64. В этом случае он может использовать адресацию 2001:db8::/96 для отображения всех адресов сети интернет. Если нам необходимо обратиться к узлу `1.1.1.1`, то мы просто посылаем запрос не на `1.1.1.1`, а на адрес `2001:db8::101:101`. Чтобы было удобнее для людей, существует специальная запись для такого применения адресов: `2001:db8::1.1.1.1`. В этом случае часть IPv6 адреса, которая содержит IPv4 адрес, записывается как есть.

Поскольку некоторое время NAT64 будет актуален, то для него был выделен специальный диапазон адресов: `64:ff9b::/96`. Именно его рекомендуют использовать внутри вашей локальной сети для вашего шлюза NAT64. Таким образом адрес `1.1.1.1` превращается в `64:ff9b::1.1.1.1`, что также можно записать также как `64:ff9b::101:101`.

Отлично. Доступ к узлам IPv4 мы получили.

```console
$ ping 64:ff9b::1.1.1.1
PING 64:ff9b::1.1.1.1 (64:ff9b::101:101) 56 data bytes
64 bytes from 64:ff9b::101:101: icmp_seq=1 ttl=59 time=48.4 ms
64 bytes from 64:ff9b::101:101: icmp_seq=2 ttl=59 time=53.8 ms
```

Но что-то тут всё равно не так. Там, где мы указываем IPv4 адреса, мы можем сменить `1.1.1.1` на `64:ff9b::1.1.1.1`. Но IP адреса мы указываем редко. В большинстве случаев мы используем доменные имена при обращении к серверам интернета. Поэтому выполним следующий шаг и перейдём к настройке специального DNS сервера.

## DNS64 или обманываем клиентов

Что происходит, когда какое-то приложение обращается по определённому доменному имени? Прежде чем обратиться к IP адресу сервера система должна этот адрес найти. Чтобы его найти, ваше устройство обращается к DNS серверу, который возвращает соответствующий доменному имени IP адрес. Рассмотрим типичный ответ на примере домена `music.yandex.ru`:

```console
$ host music.yandex.ru
music.yandex.ru has address 213.180.204.186
music.yandex.ru has IPv6 address 2a02:6b8::186
music.yandex.ru mail is handled by 10 mx.yandex.net.
```

В данном ответе мы получили записи 3 разных типов:

- A - содержащую IPv4 адрес: 213.180.204.186;
- AAAA - содержащую IPv6 адрес: 2a02:6b8::186;
- MX - адрес почтового сервера.

Что происходит, когда какое-то приложение пытается получить доступ к `music.yandex.ru`? Если у вас на устройстве есть публичный IPv6 адрес, то получив подобный ответ, возможно, операционная система попытается обратиться сначала к IPv6 адресу сервера, если это не удаётся, то произойдёт попытка связаться с сервером по IPv4 адресу. Есть и более сложные алгоритмы выбора протокола, например, описанный в RFC 8305 (Happy Eyeballs версии 2). Этот алгоритм позволяет обеспечить наиболее быстрый ответ сервиса в случае если возникли какие-то проблемы с работой IPv6, но при этом сервис по прежнему доступен по IPv4.

В современных операционных системах вопросом выбора протокола занимается даже не само приложение, а компонент операционной системы. Приложение может запросить, например, TCP соединение с узлом `music.yandex.ru` и операционная система сама найдёт нужный IP адрес и свяжется по одному из доступных протоколов, будь то IPv6 или IPv4. Приложение совершенно не интересует какой протокол будет использован на нижних уровнях. Что это значит для нас? То, что мы можем обмануть приложение и вместо соединения с IPv4 адресом инициировать соединение с IPv6. Далее наш NAT64 обеспечит соединение с тем узлом, который нам был необходим.

Для примера возьмём домен `sberbank.ru`.

```console
$ host sberbank.ru
sberbank.ru has address 194.54.14.168
sberbank.ru mail is handled by 60 email12.sberbank.ru.
sberbank.ru mail is handled by 40 email11.sberbank.ru.
```

На нём также имеются почтовые MX записи, но нас они не интересуют. Мы видим одну запись типа A, которая указывает на адрес `194.54.14.168`. Т.е. приложение запросив этот адрес будет пытаться связаться с указанным ему IPv4 адресу. Как мы можем перенаправить этот запрос на наш шлюз NAT64? Всё просто. Нужно создать поддельную запись типа AAAA, которая будет указывать на наш шлюз. Вносим необходимые правки в настройки нашего DNS сервера и теперь его ответ будет немного иной:

```console
$ host sberbank.ru
sberbank.ru has address 194.54.14.168
sberbank.ru has IPv6 address 64:ff9b::c236:ea8
sberbank.ru mail is handled by 60 email12.sberbank.ru.
sberbank.ru mail is handled by 40 email11.sberbank.ru.
```

Как вы могли заметить, теперь ответ содержит AAAA запись, которая указывает на адрес `64:ff9b::c236:ea8` (`64:ff9b::194.54.14.168`). В таком случае наша операционная система обнаружив запись AAAA для запрашиваемого узла просто попытается с ним связаться по этом адресу, передавая данные на наш шлюз NAT64. Бинго! Проверим ещё раз как теперь работает наш интернет. Теперь такие сайты, как Госуслуги, Сбербанк, ВТБ, Ростелеком и многие другие заработали!

NAT64 в связке с DNS64 позволили нам получить доступ к большей части ресурсов интернета.

К сожалению, есть небольшой недостаток такого подхода. DNS64 ломает DNSSEC. Если вы пользуетесь этим механизмом, то можете заметить, что теперь у сайтов без IPv6, но имеющих DNSSEC теперь сломан. Увы, починить это никак нельзя. С другой стороны, использование DNSSEC в РФ само по себе проблематично. Например, оператор, который предоставляет государственные услуги - Ростелеком, имеет сломанный DNSSEC на своём домене `rt.ru`. Если вы используете DNSSEC, то вы можете продолжить его использовать только на вашем DNS сервере. Клиенты теперь не будут доверять доменам у которых есть только IPv4 адреса и включен DNSSEC.

В некоторых операционных системах возможно выставить приоритеты использования IPv4 и IPv6 адресов. Например, в ОС Linux это делается с помощью настройки функции getAddrInfo в файле конфигурации `/etc/gai.conf`.

## CLAT

Итак. Мы восстановили доступ к большей части ресурсов интернета. Но остаётся вопрос торрентов и и некоторых других приложений, которые не используют доменные имена при своей работе и оперируют непосредственно IPv4 адресами, а значит будут обращаться непосредственно к этим адресам. Что делать в этом случае?

В нашей сети, которая работает только по протоколу IPv6 есть свой шлюз NAT64. Его можно назвать также PLAT (provider-side translator). Нам нужен IPv4 адрес, чтобы приложения могли отправлять пакеты IPv4, как они того желают. Сделаем свой транслятор адресов NAT46. Для этого создадим виртуальный интерфейс с IPv4 адресом и весь трафик, который будет направляться на него будем перенаправлять на наш NAT64. Такой транслятор называется CLAT (customer-side translator). Вместе CLAT и PLAT представляют собой архитектуру 464XLAT, которая позволяет передавать по сети IPv6 пакеты IPv4.

Плохая новость: CLAT необходимо устанавливать на каждое устройство, если ваша сеть работает только по протоколу IPv6. Хорошая новость: использование CLAT делает ваш доступ в интернет полноценным, а его реализация есть на большинстве мобильных ОС без дополнительной настройки. Вам будут доступны все сервисы сети без каких-либо ограничений.

Android поддерживает CLAT начиная с версии 4.3, с 2013 года. Однако, в зависимости от поставщика, могут быть некоторые отличия. Например, мне не удалось использовать CLAT на старом телефоне с Android 5.0. MIUI на телефоне Poco X3 NFC не позволяет отключить IPv4 для сотовых сетей даже несмотря на выбор режима только IPv6. Наиболее свежие телефоны с Android, в том числе, умеют распознавать специальную опцию DHCPv4 и могут не получать IPv4 адреса и активировать CLAT.

В iOs от Apple имеется своя реализация CLAT начиная с версии 12.0, которая была выпущена в 2018 году. Кроме этого, Apple требует, чтобы все приложения, которые публикуются через их App Store работали в сетях IPv6.

MacOS также имеет встроенную поддержку CLAT начиная с версии Ventura (13).

Представитель Microsoft в начале 2024 года [завил](https://techcommunity.microsoft.com/t5/networking-blog/windows-11-plans-to-expand-clat-support/ba-p/4078173) о том, что компания планирует расширить поддержку CLAT в том числе и на интерфейсы не сотовых сетей в Windows 11.

В различных дистрибутивов Linux можно найти пакеты `clatd`, которые позволяют использовать CLAT.

В целом, самая лучшая ситуация с мобильными устройствами. Они давно готовы к работе в сетях IPv6 без IPv4. А вот самый большой сегмент рынка стационарных устройств и ноутбуков на базе Windows до сих пор может работать полноценно только при использовании сотовых сетей.

## Возможности архитектуры 464XLAT

Как уже было сказано выше, транслятор CLAT не обязательно располагать непосредственно на устройстве. Его можно расположить на вашем маршрутизаторе. При этом между устройствами CLAT и PLAT трафик передаётся только с использованием IPv6, а транслятор PLAT может быть расположен, например, у вашего провайдера или вообще где-то на просторах интернета.

## Заключение

Протокол нового поколения IPv6 является полноценной заменой IPv4. Во время перехода от IPv4 к IPv6 для поддержания полноценного доступа ко всем ресурсам интернета необходимо использовать дополнительно оборудование и программное обеспечение. Однако в процессе перехода нагрузка на это оборудование будет постепенно снижаться, что выгодно отличает этот вариант от использования NAT44 на сетях провайдеров, где нагрузка на оборудование, выполняющее эти функции, только возрастает с каждым годом.
